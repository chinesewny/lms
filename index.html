<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ChineseClass By Krukong</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: radial-gradient(circle at top left, #1e3a8a, #0f172a, #000000); 
            background-attachment: fixed;
            color: #e2e8f0;
        }
        .glass-ios {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.3);
            outline: none;
        }
        .btn-blue { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-blue:hover:not(:disabled) { box-shadow: 0 0 15px rgba(37, 99, 235, 0.5); transform: translateY(-1px); }
        .btn-red { background: linear-gradient(135deg, #dc2626, #b91c1c); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-yellow { background: linear-gradient(135deg, #d97706, #b45309); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-score-active { background: #eab308 !important; color: black !important; border: 2px solid #fff !important; font-weight: bold; transform: scale(1.1); box-shadow: 0 0 15px rgba(234, 179, 8, 0.6); }
        .btn-att-active-present { background: #059669 !important; color: white !important; border-color: white !important; }
        .btn-att-active-leave { background: #d97706 !important; color: white !important; border-color: white !important; }
        .btn-att-active-absent { background: #dc2626 !important; color: white !important; border-color: white !important; }
        .status-box { transition: all 0.2s; border-radius: 12px; }
        .status-none { background: rgba(255, 255, 255, 0.05); border: 1px dashed rgba(255, 255, 255, 0.2); color: #94a3b8; }
        .status-done { background: rgba(5, 150, 105, 0.2); border: 1px solid #059669; color: #34d399; box-shadow: 0 0 10px rgba(5, 150, 105, 0.2); }
        .chapter-checkbox:checked + div { background: linear-gradient(135deg, #d97706, #b45309); color: white; border-color: white; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        #toast-notification { transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s; }
        .toast-show { transform: translate(-50%, 0) !important; opacity: 1 !important; }
        
        /* Animation for Fade In */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Focus styles for accessibility */
        .focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        @media print {
            @page { size: A4 portrait; margin: 1cm; }
            body { background: white !important; color: black !important; -webkit-print-color-adjust: exact; }
            #app-root, #toast-notification, .no-print { display: none !important; }
            #print-area { display: block !important; position: relative !important; width: 100% !important; background: white !important; color: black !important; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            thead { display: table-header-group; } 
            tr { page-break-inside: avoid; page-break-after: auto; }
            th, td { border: 1px solid #000; padding: 6px; text-align: center; color: black; }
            .print-header-row td { border: none !important; padding-bottom: 10px; }
            .column-header th { background-color: #e5e7eb !important; color: black !important; font-weight: bold; border: 1px solid #000; }
        }
        
        /* Error states */
        .error-input { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; }
        .error-message { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; }
    </style>
</head>
<body class="w-full h-full min-h-screen">
    
    <div id="app-root" class="w-full h-full min-h-screen flex items-stretch justify-center p-2 md:p-4">
        <div class="w-full max-w-7xl rounded-3xl glass-ios flex flex-col relative overflow-hidden shadow-2xl">
            
            <header class="w-full px-6 py-4 border-b border-white/10 flex flex-col md:flex-row md:items-center md:justify-between gap-4 z-10 no-print">
                <div class="flex items-center gap-4">
                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-red-600 via-yellow-500 to-blue-600 rounded-full blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
                        <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="School Logo" class="relative h-16 w-16 object-contain bg-black/20 rounded-full p-1 border border-white/10">
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white tracking-wide drop-shadow-md">Chinese<span class="text-yellow-400">Class</span> By Krukong</h1>
                        <p class="text-blue-200 text-xs">ครูกีรติ ประสพพรรังสี - กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ</p>
                    </div>
                </div>
                <nav class="inline-flex rounded-full bg-black/20 p-1 border border-white/5">
                    <button id="tab-btn-admin" onclick="switchMainTab('admin')" class="px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all" aria-label="สวิตช์ไปแท็บผู้ดูแลระบบ"><i class="fa-solid fa-chalkboard-user mr-2"></i>คุณครู</button> 
                    <button id="tab-btn-student" onclick="switchMainTab('student')" class="px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all" aria-label="สวิตช์ไปแท็บนักเรียน"><i class="fa-solid fa-user-graduate mr-2"></i>นักเรียน</button>
                </nav>
            </header>

            <main class="flex-1 w-full px-4 md:px-6 pb-6 overflow-y-auto no-print scroll-smooth">
                <div class="w-full max-w-7xl mx-auto mt-6 flex flex-col gap-6">
                    
                    <div id="section-admin" class="flex flex-col gap-5 hidden">
                        
                        <div id="admin-login-wrapper" class="flex flex-col items-center justify-center py-20 gap-8">
                            <div class="glass-ios p-10 rounded-3xl w-full max-w-sm flex flex-col items-center relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-500 via-yellow-500 to-blue-500"></div>
                                <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="Logo" class="w-24 h-24 object-contain mb-6 drop-shadow-xl">
                                <h2 class="text-2xl font-bold text-white mb-6">เข้าสู่ระบบคุณครู</h2>
                                <form id="admin-login-form" class="space-y-4 w-full">
                                    <input id="admin-username" type="text" placeholder="Username" class="w-full rounded-xl glass-input px-4 py-3 text-white placeholder-white/30 text-center" required>
                                    <input id="admin-password" type="password" placeholder="Password" class="w-full rounded-xl glass-input px-4 py-3 text-white placeholder-white/30 text-center" required>
                                    <button type="submit" class="w-full py-3 rounded-xl btn-yellow font-bold shadow-lg text-lg mt-2 flex items-center justify-center gap-2">
                                        <span id="login-spinner" class="hidden loading-spinner"></span>
                                        Login
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div id="admin-content-wrapper" class="hidden flex flex-col gap-6">
                            <div class="flex justify-between items-center glass-ios px-4 py-3 rounded-2xl">
                                <div class="flex items-center gap-3">
                                    <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-lg text-white font-bold shadow-lg ring-2 ring-white/20"><i class="fa-solid fa-user-tie"></i></div>
                                    <div><h3 class="text-sm font-bold text-white">ผู้ดูแลระบบ</h3><p class="text-[10px] text-green-400 font-bold"><i class="fa-solid fa-circle text-[8px] mr-1"></i>Online</p></div>
                                </div>
                                <button onclick="handleLogout(true)" class="bg-white/10 hover:bg-red-500/80 text-white px-4 py-2 rounded-xl text-xs font-bold transition-all border border-white/10"><i class="fa-solid fa-power-off mr-2"></i>ออก</button>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                                <button onclick="switchAdminSubTab('basic')" id="menu-basic" class="menu-btn btn-blue rounded-2xl py-3 font-bold shadow-lg"><i class="fa-solid fa-folder-open block text-xl mb-1"></i> ข้อมูล</button> 
                                <button onclick="switchAdminSubTab('scan')" id="menu-scan" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-qrcode block text-xl mb-1"></i> ให้คะแนน</button>
                                <button onclick="switchAdminSubTab('individual')" id="menu-individual" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-id-card block text-xl mb-1"></i> รายบุคคล</button>
                                <button onclick="switchAdminSubTab('report')" id="menu-report" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-print block text-xl mb-1"></i> พิมพ์/CSV</button>
                                <button onclick="switchAdminSubTab('homework')" id="menu-homework" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold relative"><i class="fa-solid fa-list-check block text-xl mb-1"></i> ตรวจงาน<span id="badge-homework" class="absolute top-2 right-2 bg-red-600 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden">0</span></button>
                                <button onclick="switchAdminSubTab('attendance')" id="menu-attendance" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-user-check block text-xl mb-1"></i> เช็คชื่อ</button>
                                <button onclick="switchAdminSubTab('material')" id="menu-material" class="menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold"><i class="fa-solid fa-book-open block text-xl mb-1"></i> เนื้อหา</button>
                            </div>

                            <!-- Panels remain the same structure, just adding proper validation -->
                            <section id="admin-panel-basic" class="admin-panel hidden glass-ios rounded-3xl p-6">
                               <!-- Content unchanged -->
                            </section>
                            
                            <section id="admin-panel-scan" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6">
                               <!-- Content unchanged -->
                            </section>

                            <section id="admin-panel-individual" class="admin-panel hidden glass-ios rounded-3xl p-6">
                               <!-- Content unchanged -->
                            </section>

                            <section id="admin-panel-report" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6">
                               <!-- Content unchanged -->
                            </section>
                            
                            <section id="admin-panel-attendance" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6">
                               <!-- Content unchanged -->
                            </section>
                            
                            <section id="admin-panel-homework" class="admin-panel hidden glass-ios rounded-3xl p-6">
                               <!-- Content unchanged -->
                            </section>
                            
                            <section id="admin-panel-material" class="admin-panel hidden glass-ios rounded-3xl p-6 flex flex-col gap-6">
                               <!-- Content unchanged -->
                            </section>
                        </div>
                    </div>

                    <div id="section-student" class="hidden flex flex-col gap-5">
                        <div id="student-login-wrapper" class="flex flex-col items-center justify-center py-20 gap-8">
                            <div class="glass-ios p-10 rounded-3xl w-full max-w-sm flex flex-col items-center relative">
                                <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="Logo" class="w-24 h-24 object-contain mb-6 drop-shadow-lg">
                                <h2 class="text-2xl font-bold text-white mb-6">นักเรียน</h2>
                                <input id="student-login-id" type="text" class="w-full glass-input rounded-xl px-4 py-3 text-center text-white text-lg" placeholder="รหัสนักเรียน">
                                <button onclick="handleStudentLogin()" class="w-full py-3 rounded-xl btn-blue font-bold shadow-lg mt-4 text-lg flex items-center justify-center gap-2">
                                    <span id="student-login-spinner" class="hidden loading-spinner"></span>
                                    เข้าใช้งาน
                                </button>
                            </div>
                        </div>
                        <div id="student-dashboard" class="hidden flex flex-col gap-6">
                            <!-- Content unchanged -->
                        </div>
                    </div>

                </div>
            </main>
            
            <!-- Modals remain the same -->
            <div id="subject-config-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md">
                <!-- Content unchanged -->
            </div>

            <div id="score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md">
                <!-- Content unchanged -->
            </div>
            
            <div id="submit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md">
                <!-- Content unchanged -->
            </div>
            
            <div id="toast-notification" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gradient-to-r from-green-600 to-teal-600 text-white px-8 py-4 rounded-full shadow-2xl z-50 flex items-center gap-3 translate-y-20 opacity-0 font-bold border border-green-400/50"><i class="fa-solid fa-circle-check text-2xl"></i><span id="toast-message" class="text-lg">บันทึกสำเร็จ</span></div>
        </div>
    </div>
    
    <div id="print-area" class="hidden">
        <!-- Content unchanged -->
    </div>

    <script>
        // ***********************************************
        // ⚠️ เปลี่ยน URL ด้านล่างให้เป็น URL ของ Google Apps Script ที่ Deploy ใหม่ของคุณ
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNjMSE06u5xO4dtyipa5P-YzoaicppubdwlUgMpaX4L4TUjk3-xY2PRnzhS42AxZe/exec"; 
        // ***********************************************

        let dataState = { 
            subjects: [], 
            classes: [], 
            students: [], 
            tasks: [], 
            scores: [], 
            attendance: [], 
            materials: [], 
            submissions: [], 
            returns: [], 
            schedules: [] 
        };
        
        let scoreMode = 'manual'; 
        let attMode = null;
        let pendingScore = null;
        let smartClassId = null; 
        let currentConfig = [];
        let inactivityTimer;
        let syncInterval;
        let scheduleInterval;

        const PERIODS = [
            { p: 1, start: "08:30", end: "09:20" }, 
            { p: 2, start: "09:20", end: "10:10" }, 
            { p: 3, start: "10:10", end: "11:00" },
            { p: 4, start: "11:00", end: "11:50" }, 
            { p: 5, start: "11:50", end: "12:40" }, 
            { p: 6, start: "12:40", end: "13:30" },
            { p: 7, start: "13:30", end: "14:20" }, 
            { p: 8, start: "14:20", end: "15:10" }
        ];

        window.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            try {
                if(document.getElementById('att-date-input')) {
                    document.getElementById('att-date-input').value = getThaiDateISO();
                }
                
                renderScoreButtons();
                initEventListeners();
                loadFromLocalStorage();
                setupInactivityTimer();
                
                const savedSession = localStorage.getItem('wany_admin_session');
                if(savedSession) { 
                    showAdminPanel(true); 
                } else { 
                    switchMainTab('student'); 
                }
                
                // Initial sync
                syncData();
                
                // Setup intervals
                checkSmartSchedule();
                scheduleInterval = setInterval(checkSmartSchedule, 60000);
                syncInterval = setInterval(syncData, 60000);
                
                // Cleanup on page unload
                window.addEventListener('beforeunload', cleanup);
                
            } catch (error) {
                console.error('Error during initialization:', error);
                showToast("เกิดข้อผิดพลาดในการเริ่มต้นระบบ", "bg-red-600");
            }
        }

        function cleanup() {
            if (inactivityTimer) clearTimeout(inactivityTimer);
            if (scheduleInterval) clearInterval(scheduleInterval);
            if (syncInterval) clearInterval(syncInterval);
        }

        function setupInactivityTimer() {
            const logout = () => { 
                showToast("หมดเวลาการใช้งาน (30 นาที)", "bg-yellow-600");
                handleLogout(true); 
            };
            
            const resetTimer = () => {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(logout, 30 * 60 * 1000);
            };
            
            window.addEventListener('load', resetTimer);
            document.addEventListener('mousemove', resetTimer);
            document.addEventListener('keypress', resetTimer);
            document.addEventListener('click', resetTimer);
        }

        async function syncData() {
            try {
                const wifiIcon = document.querySelector('.fa-wifi');
                if (wifiIcon) {
                    wifiIcon.classList.remove('text-green-400');
                    wifiIcon.classList.add('text-yellow-400');
                }
                
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData&t=${new Date().getTime()}`);
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const json = await res.json();
                
                if (json && typeof json === 'object') { 
                    // Ensure all arrays exist
                    const requiredArrays = ['subjects', 'classes', 'students', 'tasks', 'scores', 
                                          'attendance', 'materials', 'submissions', 'returns', 'schedules'];
                    
                    requiredArrays.forEach(key => {
                        if (!Array.isArray(json[key])) {
                            json[key] = [];
                        }
                    });
                    
                    dataState = json;
                    refreshUI(); 
                    saveToLocalStorage();
                    
                    if (wifiIcon) {
                        wifiIcon.classList.remove('text-yellow-400');
                        wifiIcon.classList.add('text-green-400');
                        setTimeout(() => wifiIcon.classList.remove('text-green-400'), 1000);
                    }
                }
            } catch(e) { 
                console.warn('Sync failed, using offline data:', e);
                showToast("Offline Mode - ใช้ข้อมูลล่าสุด", "bg-yellow-600");
            }
        }

        function saveToLocalStorage() { 
            try {
                localStorage.setItem('wany_data_backup', JSON.stringify({ 
                    timestamp: new Date().getTime(), 
                    data: dataState 
                }));
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
            }
        }

        function loadFromLocalStorage() { 
            try {
                const backup = localStorage.getItem('wany_data_backup');
                if (backup) { 
                    const parsed = JSON.parse(backup);
                    if (new Date().getTime() - parsed.timestamp < 1800000) { // 30 minutes
                        dataState = parsed.data;
                    }
                }
            } catch (e) {
                console.warn('Failed to load from localStorage:', e);
            }
        }

        window.handleLogout = function(force = false) { 
            if (force || confirm("ออกจากระบบ?")) { 
                cleanup();
                localStorage.removeItem('wany_admin_session');
                localStorage.removeItem('current_student_code');
                location.reload();
            }
        };

        function showAdminPanel(auto = false) { 
            document.getElementById('admin-login-wrapper').classList.add('hidden'); 
            document.getElementById('admin-content-wrapper').classList.remove('hidden'); 
            refreshUI(); 
            if (!auto) syncData(); 
        }

        function refreshUI() {
            refreshDropdowns();
            renderSubjectList();
            renderScheduleList();
            checkSmartSchedule();
            
            // Only update visible panels
            const panels = ['scan', 'report', 'homework', 'attendance', 'material'];
            panels.forEach(panel => {
                const panelElement = document.getElementById(`admin-panel-${panel}`);
                if (panelElement && !panelElement.classList.contains('hidden')) {
                    switch(panel) {
                        case 'scan': 
                            updateScanTaskDropdown(); 
                            renderScoreRoster(); 
                            break;
                        case 'report': 
                            renderGradeReport(); 
                            break;
                        case 'homework': 
                            renderIncomingSubmissions(); 
                            break;
                        case 'attendance': 
                            renderAttRoster(); 
                            break;
                        case 'material': 
                            renderAdminMaterials(); 
                            break;
                    }
                }
            });
            
            updateInboxBadge();
            
            const studentDashboard = document.getElementById('student-dashboard');
            if (studentDashboard && !studentDashboard.classList.contains('hidden')) {
                const code = localStorage.getItem('current_student_code');
                if (code) { 
                    const student = dataState.students.find(x => x.code == code);
                    if (student) renderStudentDashboard(student);
                }
            }
        }

        // --- INDIVIDUAL CHECK LOGIC ---
        let searchDebounceTimer;
        window.searchIndividual = (term) => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                const div = document.getElementById('individual-search-results');
                if (!div) return;
                
                div.innerHTML = '';
                
                if (term.length < 2) { 
                    div.classList.add('hidden'); 
                    return; 
                }
                
                const normalizedTerm = term.trim().toLowerCase();
                const matches = dataState.students.filter(s => 
                    (s.name && s.name.toLowerCase().includes(normalizedTerm)) || 
                    (s.code && String(s.code).includes(term)) || 
                    (s.no && String(s.no).includes(term))
                );
                
                if (matches.length === 0) { 
                    div.innerHTML = '<div class="p-3 text-white/50 text-sm text-center">ไม่พบข้อมูล</div>'; 
                } else {
                    matches.slice(0, 10).forEach(s => {
                        const el = document.createElement('div');
                        const clsName = dataState.classes.find(c => c.id == s.classId)?.name || '?';
                        el.className = "p-3 hover:bg-white/10 cursor-pointer border-b border-white/5 text-sm text-white";
                        el.innerHTML = `<span class="font-bold text-yellow-400">${s.name || 'ไม่มีชื่อ'}</span> <span class="text-xs text-white/50">(${clsName})</span>`;
                        el.onclick = () => {
                            document.getElementById('individual-search').value = s.name;
                            div.classList.add('hidden');
                            showIndividualProfile(s.id);
                        };
                        div.appendChild(el);
                    });
                }
                div.classList.remove('hidden');
            }, 300);
        };

        function showIndividualProfile(sid) {
            const s = dataState.students.find(x => x.id == sid);
            if (!s) {
                showToast("ไม่พบข้อมูลนักเรียน", "bg-red-600");
                return;
            }
            
            const cls = dataState.classes.find(c => c.id == s.classId) || { name: '-', subjectId: 0 };
            const container = document.getElementById('individual-result-container');
            
            if (!container) return;
            
            container.classList.remove('hidden');
            document.getElementById('ind-name').textContent = s.name || 'ไม่มีชื่อ';
            document.getElementById('ind-id').textContent = s.code || '-';
            document.getElementById('ind-class').textContent = cls.name;

            // 1. Attendance Check
            const atts = dataState.attendance.filter(a => a.studentId == sid);
            let p = 0, l = 0, a = 0;
            let absentDates = [];
            
            atts.forEach(att => {
                if (att.status == 'มา') p++;
                else if (att.status == 'ลา') l++;
                else if (att.status == 'ขาด') { 
                    a++; 
                    absentDates.push(formatThaiDate(att.date));
                }
            });
            
            document.getElementById('ind-att-present').textContent = p;
            document.getElementById('ind-att-leave').textContent = l;
            document.getElementById('ind-att-absent').textContent = a;
            
            const absentDatesElement = document.getElementById('ind-absent-dates');
            if (absentDatesElement) {
                absentDatesElement.innerHTML = absentDates.length > 0 
                    ? absentDates.map(d => `<span class="inline-block bg-red-500/20 px-2 py-1 rounded mr-1 mb-1 border border-red-500/30">${d}</span>`).join('') 
                    : '- ไม่มีการขาดเรียน -';
            }

            // 2. Work Check
            const tasks = dataState.tasks.filter(t => t.classId == s.classId);
            let completed = 0;
            const missingList = document.getElementById('ind-missing-list');
            
            if (missingList) {
                missingList.innerHTML = '';
                
                tasks.forEach(t => {
                    const hasScore = dataState.scores.some(sc => sc.studentId == sid && sc.taskId == t.id);
                    const hasSub = dataState.submissions.some(sb => sb.studentId == sid && sb.taskId == t.id);
                    
                    if (hasScore || hasSub) {
                        completed++;
                    } else {
                        const el = document.createElement('div');
                        el.className = "flex items-center justify-between p-2 bg-red-500/10 border border-red-500/20 rounded-lg text-xs";
                        el.innerHTML = `<span class="text-white/90 truncate">${t.name || 'ไม่มีชื่อ'}</span><span class="bg-red-500 text-white px-2 py-0.5 rounded text-[9px] font-bold">ค้างส่ง</span>`;
                        missingList.appendChild(el);
                    }
                });
                
                const progressBar = document.getElementById('ind-work-bar');
                const progressText = document.getElementById('ind-work-progress-text');
                
                if (tasks.length > 0) {
                    const progress = Math.round((completed / tasks.length) * 100);
                    progressText.textContent = `${progress}%`;
                    progressBar.style.width = `${progress}%`;
                } else {
                    progressText.textContent = "0%";
                    progressBar.style.width = "0%";
                    missingList.innerHTML = '<div class="text-center text-white/30 py-2">ไม่มีงานมอบหมาย</div>';
                }
            }

            // 3. GPA Estimate
            const { total } = calculateScores(sid, s.classId, tasks);
            const gpaElement = document.getElementById('ind-gpa');
            if (gpaElement) {
                gpaElement.textContent = calGrade(total);
            }
        }

        // --- Subject Score Config Logic ---
        function renderSubjectList() {
            const div = document.getElementById('subject-list-container');
            if (!div) return;
            
            div.innerHTML = '';
            dataState.subjects.forEach(s => {
                const el = document.createElement('div');
                el.className = "p-3 bg-white/5 rounded-lg border border-white/5 cursor-pointer hover:bg-white/10 transition-all flex justify-between items-center";
                const config = s.scoreConfig || [];
                const slots = config.length > 0 ? `${config.length} ช่อง` : 'ค่าเริ่มต้น (5)';
                el.innerHTML = `<div><div class="font-bold text-sm text-white">${s.name || 'ไม่มีชื่อ'}</div><div class="text-xs text-white/50">โครงสร้างคะแนน: ${slots}</div></div><i class="fa-solid fa-gear text-white/30"></i>`;
                el.onclick = () => openSubjectConfig(s.id);
                div.appendChild(el);
            });
        }

        function openSubjectConfig(sid) {
            const s = dataState.subjects.find(x => x.id == sid);
            if (!s) return;
            
            document.getElementById('config-subject-id').value = sid;
            document.getElementById('config-subject-name').textContent = s.name;
            currentConfig = s.scoreConfig ? JSON.parse(JSON.stringify(s.scoreConfig)) : Array(5).fill(10);
            renderConfigSlots();
            document.getElementById('subject-config-modal').classList.remove('hidden');
        }

        function renderConfigSlots() {
            const div = document.getElementById('config-slots-container');
            if (!div) return;
            
            div.innerHTML = '';
            let total = 0;
            
            currentConfig.forEach((score, idx) => {
                const numericScore = Number(score) || 0;
                total += numericScore;
                const row = document.createElement('div');
                row.className = "flex items-center gap-2";
                row.innerHTML = `
                    <span class="text-xs text-white/70 w-16">ช่องที่ ${idx + 1}</span>
                    <input type="number" value="${numericScore}" onchange="updateConfigSlot(${idx}, this.value)" 
                           class="flex-1 glass-input rounded px-2 py-1 text-sm text-center" min="0" max="50">
                    <button onclick="removeConfigSlot(${idx})" class="text-red-400 hover:text-red-300 px-2" 
                            aria-label="ลบช่องคะแนนนี้">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                div.appendChild(row);
            });
            
            const totalEl = document.getElementById('config-total-score');
            if (totalEl) {
                totalEl.textContent = total;
                totalEl.className = total > 50 ? "font-bold text-red-400" : "font-bold text-green-400";
            }
            
            const addButton = document.getElementById('btn-add-slot');
            if (addButton) {
                addButton.style.display = currentConfig.length >= 5 ? 'none' : 'block';
            }
        }

        window.updateConfigSlot = (idx, val) => {
            const numericVal = Math.max(0, Math.min(50, Number(val) || 0));
            currentConfig[idx] = numericVal;
            renderConfigSlots();
        };

        window.removeConfigSlot = (idx) => {
            if (currentConfig.length > 1) {
                currentConfig.splice(idx, 1);
                renderConfigSlots();
            }
        };

        window.addConfigSlot = () => {
            if (currentConfig.length < 5) {
                currentConfig.push(10);
                renderConfigSlots();
            }
        };

        window.saveSubjectConfig = () => {
            const total = currentConfig.reduce((a, b) => a + (Number(b) || 0), 0);
            if (total > 50) {
                showToast("คะแนนเก็บรวมต้องไม่เกิน 50 คะแนน", "bg-red-600");
                return;
            }
            
            const sid = document.getElementById('config-subject-id').value;
            const s = dataState.subjects.find(x => x.id == sid);
            
            if (s) { 
                s.scoreConfig = currentConfig; 
                saveAndRefresh({ 
                    action: 'updateSubjectConfig', 
                    id: sid, 
                    config: currentConfig 
                }); 
                document.getElementById('subject-config-modal').classList.add('hidden'); 
                showToast("บันทึกโครงสร้างคะแนนแล้ว");
            }
        };

        function calculateScores(studentId, classId, tasks) {
            const cls = dataState.classes.find(c => c.id == classId);
            if (!cls) return { chapScores: [], midterm: 0, final: 0, total: 0 };
            
            const subj = dataState.subjects.find(s => s.id == cls.subjectId);
            const config = (subj && subj.scoreConfig && subj.scoreConfig.length > 0) 
                ? subj.scoreConfig 
                : Array(5).fill(10);
            
            let chapData = config.map((maxWeight) => ({ 
                earn: 0, 
                maxTask: 0, 
                weight: Number(maxWeight) || 0 
            }));
            
            let midterm = 0, final = 0, totalScore = 0;
            
            tasks.forEach(t => {
                const sc = dataState.scores.find(x => x.studentId == studentId && x.taskId == t.id);
                const score = sc && !isNaN(Number(sc.score)) ? Number(sc.score) : 0;
                const max = !isNaN(Number(t.maxScore)) ? Number(t.maxScore) : 0;
                
                if (t.category === 'accum') {
                    const chapters = t.chapter ? t.chapter.toString().split(',') : [];
                    if (chapters.length > 0 && max > 0) { 
                        const splitMax = max / chapters.length;
                        const splitScore = score / chapters.length;
                        chapters.forEach(c => {
                            const idx = parseInt(c) - 1;
                            if (idx >= 0 && idx < chapData.length) {
                                chapData[idx].maxTask += splitMax;
                                chapData[idx].earn += splitScore;
                            }
                        });
                    }
                } else if (t.category === 'midterm') {
                    midterm += score;
                } else if (t.category === 'final') {
                    final += score;
                }
                if (t.category === 'special') {
                    totalScore += score;
                }
            });
            
            const chapScores = chapData.map(d => {
                if (d.maxTask === 0) return 0;
                return Math.round((d.earn / d.maxTask) * d.weight);
            });
            
            totalScore += chapScores.reduce((a, b) => a + b, 0) + midterm + final;
            return { chapScores, midterm, final, total: totalScore };
        }

        // --- Grade Report Functions ---
        function renderGradeReport() { 
            const cid = document.getElementById('report-class')?.value;
            const thead = document.getElementById('report-table-header');
            const tbody = document.getElementById('report-table-body');
            
            if (!thead || !tbody) return;
            
            tbody.innerHTML = '';
            thead.innerHTML = '';
            
            if (!cid) return;
            
            const cls = dataState.classes.find(c => c.id == cid);
            if (!cls) return;
            
            const subj = dataState.subjects.find(s => s.id == cls.subjectId);
            const config = (subj && subj.scoreConfig && subj.scoreConfig.length > 0) 
                ? subj.scoreConfig 
                : Array(5).fill(10);
            
            let hHTML = `<th class="px-2 py-4 text-center">#</th><th class="px-2 py-4 text-left min-w-[150px]">ชื่อ-นามสกุล</th>`;
            config.forEach((m, i) => {
                hHTML += `<th class="px-1 py-4 text-center text-yellow-400">CH${i+1}<br><span class="text-[9px] opacity-50">(${m})</span></th>`;
            });
            hHTML += `<th class="px-1 py-4 text-center text-blue-400">กลาง</th>
                      <th class="px-1 py-4 text-center text-red-400">ปลาย</th>
                      <th class="px-2 py-4 text-center text-white font-bold bg-white/10">รวม</th>
                      <th class="px-2 py-4 text-center">เกรด</th>`;
            thead.innerHTML = hHTML;
            
            const tasks = dataState.tasks.filter(t => t.classId == cid);
            const students = dataState.students
                .filter(s => s.classId == cid)
                .sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
            
            students.forEach((s, idx) => { 
                const { chapScores, midterm, final, total } = calculateScores(s.id, cid, tasks);
                const grade = calGrade(total);
                
                const tr = document.createElement('tr'); 
                tr.className = "hover:bg-white/5 transition-colors";
                
                let html = `<td class="text-center text-white/50">${s.no || idx + 1}</td>
                           <td class="px-2 py-3 text-white text-xs">${s.name || 'ไม่มีชื่อ'}</td>`;
                chapScores.forEach(score => {
                    html += `<td class="text-center text-yellow-400 font-mono">${score}</td>`;
                });
                html += `<td class="text-center text-blue-400 font-bold">${midterm}</td>
                        <td class="text-center text-red-400 font-bold">${final}</td>
                        <td class="text-center font-bold text-white bg-white/10">${total}</td>
                        <td class="text-center text-green-400 font-bold text-lg">${grade}</td>`;
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }
        
        function printOfficialReport() {
            const cid = document.getElementById('report-class')?.value;
            if (!cid) {
                showToast("กรุณาเลือกห้องก่อนพิมพ์", "bg-yellow-600");
                return;
            }
            
            const cls = dataState.classes.find(c => c.id == cid);
            const subj = dataState.subjects.find(s => s.id == cls?.subjectId);
            
            if (!cls || !subj) {
                showToast("ไม่พบข้อมูลวิชาหรือห้องเรียน", "bg-red-600");
                return;
            }
            
            const config = (subj && subj.scoreConfig && subj.scoreConfig.length > 0) 
                ? subj.scoreConfig 
                : Array(5).fill(10);
            
            const headerRow = document.querySelector('#print-table .column-header');
            if (!headerRow) return;
            
            let hHTML = `<th style="width: 5%;">ที่</th>
                        <th style="width: 10%;">รหัส</th>
                        <th style="width: 25%;">ชื่อ - นามสกุล</th>`;
            
            config.forEach((m, i) => {
                hHTML += `<th>ช่อง ${i + 1} (${m})</th>`;
            });
            
            hHTML += `<th>กลางภาค</th>
                     <th>ปลายภาค</th>
                     <th>รวม</th>
                     <th>เกรด</th>`;
            
            headerRow.innerHTML = hHTML;
            
            const tbody = document.getElementById('print-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = "";
            const subtitle = document.getElementById('print-subtitle');
            if (subtitle) {
                subtitle.textContent = `ห้อง ${cls.name} วิชา ${subj.name}`;
            }
            
            const tasks = dataState.tasks.filter(t => t.classId == cid);
            const students = dataState.students
                .filter(s => s.classId == cid)
                .sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
            
            students.forEach((s, idx) => {
                const { chapScores, midterm, final, total } = calculateScores(s.id, cid, tasks);
                const tr = document.createElement('tr');
                tr.className = "print-row";
                
                let html = `<td>${s.no || idx + 1}</td>
                           <td>${s.code || '-'}</td>
                           <td style="text-align:left;">${s.name || 'ไม่มีชื่อ'}</td>`;
                
                chapScores.forEach(sc => {
                    html += `<td>${sc}</td>`;
                });
                
                html += `<td>${midterm}</td>
                        <td>${final}</td>
                        <td>${total}</td>
                        <td>${calGrade(total)}</td>`;
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
            
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function renderScoreRoster() { 
            const cid = document.getElementById('scan-class-select')?.value;
            const taskId = document.getElementById('scan-task-select')?.value;
            const div = document.getElementById('score-roster-grid');
            
            if (!div) return;
            div.innerHTML = '';
            
            if (!cid || !taskId) return;
            
            const students = dataState.students
                .filter(s => s.classId == cid)
                .sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
            
            const task = dataState.tasks.find(t => t.id == taskId);
            if (!task) return;
            
            students.forEach(s => { 
                const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == taskId);
                const val = sc ? sc.score : '-'; 
                
                const el = document.createElement('div');
                el.className = `status-box ${sc ? 'status-done' : 'status-none'} p-2 flex flex-col items-center justify-center cursor-pointer`;
                el.onclick = () => {
                    pendingScore = { s, t: task };
                    const modal = document.getElementById('score-modal');
                    if (!modal) return;
                    
                    modal.classList.remove('hidden');
                    document.getElementById('modal-task-name').textContent = task.name;
                    document.getElementById('modal-student-name').textContent = s.name;
                    document.getElementById('modal-max-score').textContent = task.maxScore;
                    document.getElementById('modal-score-input').value = val == '-' ? '' : val;
                    
                    setTimeout(() => {
                        const input = document.getElementById('modal-score-input');
                        if (input) input.focus();
                    }, 100);
                };
                
                el.innerHTML = `<div class="text-xs opacity-70">No. ${s.no || '?'}</div>
                               <div class="font-bold text-center text-xs truncate w-full">${s.name || 'ไม่มีชื่อ'}</div>
                               <div class="text-xl font-bold mt-1">${val}</div>`;
                div.appendChild(el);
            });
        }

        // --- Helpers ---
        async function saveAndRefresh(payload) {
            try {
                updateLocalState(payload);
                refreshUI();
                
                if (payload.action === 'login') {
                    // Handle login separately
                    const loginSpinner = document.getElementById('login-spinner');
                    if (loginSpinner) loginSpinner.classList.remove('hidden');
                    
                    const res = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (loginSpinner) loginSpinner.classList.add('hidden');
                    
                    const result = await res.json();
                    return result;
                } else {
                    // Send other updates
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                }
            } catch(e) {
                console.error('Save error:', e);
                showToast("บันทึกไม่สำเร็จ (ตรวจสอบเน็ต)", "bg-red-600");
            }
        }

        function updateLocalState(p) {
            if (!p || !p.action) return;
            
            switch(p.action) {
                case 'addSubject':
                    dataState.subjects.push({ id: p.id, name: p.name, scoreConfig: [] });
                    break;
                    
                case 'updateSubjectConfig':
                    const subject = dataState.subjects.find(x => x.id == p.id);
                    if (subject) subject.scoreConfig = p.config;
                    break;
                    
                case 'addClass':
                    dataState.classes.push({ id: p.id, name: p.name, subjectId: p.subjectId });
                    break;
                    
                case 'addStudent':
                    dataState.students.push({
                        id: p.id,
                        classId: p.classId,
                        no: p.no || 0,
                        code: p.code || '',
                        name: p.name || ''
                    });
                    break;
                    
                case 'addTask':
                    if (Array.isArray(p.classIds)) {
                        p.classIds.forEach((cid, idx) => {
                            const chapStr = Array.isArray(p.chapter) ? p.chapter.join(',') : p.chapter;
                            dataState.tasks.push({
                                id: Number(p.id) + idx,
                                classId: cid,
                                subjectId: p.subjectId,
                                category: p.category,
                                chapter: chapStr,
                                name: p.name,
                                maxScore: p.maxScore || 10,
                                dueDateISO: p.dueDateISO
                            });
                        });
                    }
                    break;
                    
                case 'addScore':
                    const scoreIndex = dataState.scores.findIndex(s => 
                        s.studentId == p.studentId && s.taskId == p.taskId
                    );
                    if (scoreIndex >= 0) {
                        dataState.scores[scoreIndex].score = p.score;
                    } else {
                        dataState.scores.push({
                            studentId: p.studentId,
                            taskId: p.taskId,
                            score: p.score
                        });
                    }
                    
                    // Remove from returns if exists
                    if (dataState.returns) {
                        dataState.returns = dataState.returns.filter(r => 
                            !(r.studentId == p.studentId && r.taskId == p.taskId)
                        );
                    }
                    break;
                    
                case 'addAttendance':
                    const attIndex = dataState.attendance.findIndex(a => 
                        a.studentId == p.studentId && a.date == p.date
                    );
                    if (attIndex >= 0) {
                        dataState.attendance[attIndex].status = p.status;
                    } else {
                        dataState.attendance.push({
                            studentId: p.studentId,
                            classId: p.classId,
                            date: p.date,
                            status: p.status
                        });
                    }
                    break;
                    
                case 'addMaterial':
                    dataState.materials.push({
                        id: p.id,
                        subjectId: p.subjectId,
                        title: p.title,
                        link: p.link,
                        type: p.type || 'link'
                    });
                    break;
                    
                case 'addSchedule':
                    dataState.schedules.push({
                        id: p.id,
                        day: p.day,
                        period: p.period,
                        classId: p.classId
                    });
                    break;
                    
                case 'returnForRevision':
                    dataState.submissions = dataState.submissions.filter(s => 
                        !(s.studentId == p.studentId && s.taskId == p.taskId)
                    );
                    
                    if (!dataState.returns) dataState.returns = [];
                    dataState.returns.push({
                        taskId: p.taskId,
                        studentId: p.studentId,
                        comment: p.comment,
                        timestampISO: new Date().toISOString()
                    });
                    break;
                    
                case 'submitTask':
                    if (Array.isArray(p.studentIds)) {
                        p.studentIds.forEach(sid => {
                            dataState.submissions = dataState.submissions.filter(s => 
                                !(s.studentId == sid && s.taskId == p.taskId)
                            );
                            
                            if (dataState.returns) {
                                dataState.returns = dataState.returns.filter(r => 
                                    !(r.studentId == sid && r.taskId == p.taskId)
                                );
                            }
                            
                            dataState.submissions.push({
                                taskId: p.taskId,
                                studentId: sid,
                                link: p.link,
                                timestampISO: new Date().toISOString(),
                                comment: p.comment
                            });
                        });
                    }
                    break;
            }
        }
        
        function checkSmartSchedule() {
            if (!Array.isArray(dataState.schedules)) return;
            
            const now = new Date();
            const day = now.getDay();
            const timeStr = now.toTimeString().slice(0, 5);
            let currentPeriod = PERIODS.find(p => timeStr >= p.start && timeStr <= p.end);
            
            const banner = document.getElementById('smart-att-banner');
            if (!banner) return;
            
            if (currentPeriod) {
                const match = dataState.schedules.find(s => 
                    s.day == day && s.period == currentPeriod.p
                );
                
                if (match) {
                    const cls = dataState.classes.find(c => c.id == match.classId);
                    if (cls) {
                        banner.classList.remove('hidden');
                        document.getElementById('smart-period').textContent = currentPeriod.p;
                        document.getElementById('smart-class-name').textContent = cls.name;
                        smartClassId = cls.id;
                        return;
                    }
                }
            }
            
            banner.classList.add('hidden');
            smartClassId = null;
        }

        window.useSmartClass = function() {
            if (smartClassId) {
                const select = document.getElementById('att-class-select');
                if (select) {
                    select.value = smartClassId;
                    renderAttRoster();
                }
            }
        }

        function renderScheduleList() {
            const div = document.getElementById('schedule-list');
            if (!div) return;
            
            div.innerHTML = '';
            
            if (!Array.isArray(dataState.schedules)) return;
            
            const days = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัส', 'ศุกร์', 'เสาร์'];
            const sorted = [...dataState.schedules].sort((a, b) => 
                (a.day - b.day) || (a.period - b.period)
            );
            
            sorted.forEach(s => {
                const clsName = dataState.classes.find(c => c.id == s.classId)?.name || '?';
                const row = document.createElement('div');
                row.className = "flex justify-between items-center text-xs text-white/70 bg-white/5 p-2 rounded border border-white/5";
                row.innerHTML = `<span>${days[s.day]} คาบ ${s.period}</span> <span class="text-yellow-400 font-bold">${clsName}</span>`;
                div.appendChild(row);
            });
        }

        window.exportAttendanceCSV = function() {
            const cid = document.getElementById('att-class-select')?.value;
            if (!cid) {
                showToast("กรุณาเลือกห้องเรียน", "bg-yellow-600");
                return;
            }
            
            const cls = dataState.classes.find(c => c.id == cid);
            if (!cls) return;
            
            const students = dataState.students
                .filter(s => s.classId == cid)
                .sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
                
            const logs = dataState.attendance.filter(a => a.classId == cid);
            const dates = [...new Set(logs.map(a => a.date))].sort();
            
            let csv = "\uFEFFNo,ID,Name," + dates.join(",") + ",Present,Absent,Late,Percent\n";
            
            students.forEach((s, idx) => {
                let row = [s.no || (idx + 1), s.code || '-', `"${s.name || 'ไม่มีชื่อ'}"`];
                let p = 0, a = 0, l = 0;
                
                dates.forEach(d => {
                    const log = logs.find(x => x.studentId == s.id && x.date == d);
                    const st = log ? log.status : '-';
                    row.push(st);
                    
                    if (st == 'มา') p++;
                    if (st == 'ขาด') a++;
                    if (st == 'ลา') l++;
                });
                
                const total = p + a + l;
                const percent = total > 0 ? Math.round((p / total) * 100) : 0;
                row.push(p, a, l, percent + '%');
                csv += row.join(",") + "\n";
            });
            
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csv);
            const link = document.createElement("a");
            link.href = encodedUri;
            link.download = `Attendance_${cls.name}_${getThaiDateISO()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.exportGradeCSV = function() {
            const cid = document.getElementById('report-class')?.value;
            if (!cid) {
                showToast("กรุณาเลือกห้องเรียน", "bg-yellow-600");
                return;
            }
            
            const className = dataState.classes.find(c => c.id == cid)?.name || "Unknown";
            const students = dataState.students
                .filter(s => s.classId == cid)
                .sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
                
            const tasks = dataState.tasks.filter(t => t.classId == cid);
            
            let csvContent = "\uFEFFNo,StudentID,Name,Chapter1,Chapter2,Chapter3,Chapter4,Chapter5,Chapter6,Midterm,Final,Total,Grade\n";
            
            students.forEach((s, idx) => {
                const { chapScores, midterm, final, total } = calculateScores(s.id, cid, tasks);
                const grade = calGrade(total);
                
                let row = [
                    s.no || (idx + 1),
                    `"${s.code || '-'}"`,
                    `"${s.name || 'ไม่มีชื่อ'}"`,
                    ...chapScores,
                    midterm,
                    final,
                    total,
                    grade
                ];
                
                csvContent += row.join(",") + "\n";
            });
            
            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            link.download = `GradeReport_${className}_${getThaiDateISO()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        function renderIncomingSubmissions() {
            const container = document.getElementById('incoming-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            let pending = dataState.submissions.filter(sub => 
                !dataState.scores.some(sc => sc.taskId == sub.taskId && sc.studentId == sub.studentId)
            );
            
            pending.sort((a, b) => new Date(b.timestampISO) - new Date(a.timestampISO));
            
            if (pending.length === 0) {
                container.innerHTML = '<div class="text-center text-white/50 py-10">ไม่มีงานที่รอตรวจ</div>';
                return;
            }
            
            pending.forEach(sub => {
                const task = dataState.tasks.find(t => t.id == sub.taskId);
                const student = dataState.students.find(s => s.id == sub.studentId);
                
                if (!task || !student) return;
                
                const div = document.createElement('div');
                div.className = "bg-white/5 p-4 rounded-xl border border-white/10 flex flex-col gap-3";
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="bg-blue-500/20 text-blue-300 text-[10px] px-2 py-0.5 rounded font-bold">
                                ${dataState.classes.find(c => c.id == student.classId)?.name || '-'}
                            </span>
                            <h4 class="font-bold text-white text-sm mt-1">${task.name || 'ไม่มีชื่อ'}</h4>
                            <p class="text-xs text-yellow-400">${student.name || 'ไม่มีชื่อ'} (No.${student.no || '?'})</p>
                        </div>
                        <a href="${sub.link}" target="_blank" class="text-blue-400 text-xs hover:underline">
                            <i class="fa-solid fa-link"></i> เปิดงาน
                        </a>
                    </div>
                    ${sub.comment ? `<div class="bg-black/20 p-2 rounded text-xs text-white/70 border-l-2 border-blue-500">"${sub.comment}"</div>` : ''}
                    <div class="flex gap-2 items-center">
                        <input id="grade-${sub.taskId}-${sub.studentId}" type="number" 
                               class="glass-input rounded px-2 py-1 text-xs w-20 text-center" 
                               placeholder="Max ${task.maxScore}" max="${task.maxScore}">
                        <button onclick="submitGrade('${sub.studentId}', '${sub.taskId}', ${task.maxScore})" 
                                class="btn-blue px-3 py-1 rounded text-xs font-bold">
                            ให้คะแนน
                        </button>
                        <button onclick="returnWork('${sub.studentId}', '${sub.taskId}')" 
                                class="btn-yellow px-3 py-1 rounded text-xs">
                            ส่งคืน
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        window.submitGrade = function(sid, tid, max) {
            const input = document.getElementById(`grade-${tid}-${sid}`);
            if (!input) return;
            
            const val = input.value.trim();
            if (val === '') {
                showToast("กรุณาใส่คะแนน", "bg-yellow-600");
                return;
            }
            
            const numericVal = Number(val);
            if (isNaN(numericVal)) {
                showToast("กรุณาใส่คะแนนเป็นตัวเลข", "bg-red-600");
                return;
            }
            
            if (numericVal > Number(max)) {
                showToast("คะแนนเกินค่าเต็ม", "bg-red-600");
                return;
            }
            
            saveAndRefresh({ 
                action: 'addScore', 
                studentId: sid, 
                taskId: tid, 
                score: numericVal 
            });
            
            showToast("บันทึกคะแนนสำเร็จ");
        };

        window.returnWork = function(sid, tid) {
            const reason = prompt("ระบุเหตุผลที่ส่งคืน (นักเรียนจะเห็นข้อความนี้):");
            if (reason) {
                saveAndRefresh({ 
                    action: 'returnForRevision', 
                    studentId: sid, 
                    taskId: tid, 
                    comment: reason 
                });
                showToast("ส่งคืนงานเรียบร้อย");
            }
        };

        window.closeScoreModal = function() {
            const modal = document.getElementById('score-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
            
            setTimeout(() => {
                const scanInput = document.getElementById('scan-score-input');
                if (scanInput) scanInput.focus();
            }, 300);
        };

        function getThaiDateISO() {
            try {
                const now = new Date();
                const timezoneOffset = 7 * 60; // Thailand is UTC+7
                const localTime = now.getTime() + (timezoneOffset * 60000);
                const thaiDate = new Date(localTime);
                
                const year = thaiDate.getFullYear();
                const month = String(thaiDate.getMonth() + 1).padStart(2, '0');
                const day = String(thaiDate.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            } catch (e) {
                // Fallback to simple date
                return new Date().toISOString().slice(0, 10);
            }
        }

        function formatThaiDate(dateString) {
            if (!dateString) return "-";
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return "-";
                
                return date.toLocaleDateString('th-TH', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function calGrade(score) {
            const s = Number(score) || 0;
            if (s >= 80) return 4;
            if (s >= 75) return 3.5;
            if (s >= 70) return 3;
            if (s >= 65) return 2.5;
            if (s >= 60) return 2;
            if (s >= 55) return 1.5;
            if (s >= 50) return 1;
            return 0;
        }

        function showToast(message, bgClass = "bg-gradient-to-r from-green-600 to-teal-600") {
            const toast = document.getElementById('toast-notification');
            const messageEl = document.getElementById('toast-message');
            
            if (!toast || !messageEl) return;
            
            messageEl.textContent = message;
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 ${bgClass} text-white px-8 py-4 rounded-full shadow-2xl z-50 flex items-center gap-3 translate-y-20 opacity-0 font-bold border border-green-400/50 toast-show`;
            
            setTimeout(() => {
                toast.classList.remove('toast-show');
            }, 3000);
        }

        function updateInboxBadge() {
            let count = 0;
            dataState.submissions.forEach(sub => {
                if (!dataState.scores.some(sc => sc.taskId == sub.taskId && sc.studentId == sub.studentId)) {
                    count++;
                }
            });
            
            const badge = document.getElementById('badge-homework');
            if (!badge) return;
            
            if (count > 0) {
                badge.classList.remove('hidden');
                badge.textContent = count > 99 ? '99+' : count;
            } else {
                badge.classList.add('hidden');
            }
        }

        function switchMainTab(t) {
            // Hide all sections
            document.getElementById('section-admin').classList.add('hidden');
            document.getElementById('section-student').classList.add('hidden');
            
            // Show selected section
            const section = document.getElementById(`section-${t}`);
            if (section) {
                section.classList.remove('hidden');
            }
            
            // Update button styles
            const btnA = document.getElementById('tab-btn-admin');
            const btnS = document.getElementById('tab-btn-student');
            
            if (t == 'admin') {
                btnA.className = "px-6 py-2 rounded-full text-sm font-bold bg-white text-blue-900 shadow-lg transition-all";
                btnS.className = "px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all";
            } else {
                btnS.className = "px-6 py-2 rounded-full text-sm font-bold bg-white text-blue-900 shadow-lg transition-all";
                btnA.className = "px-6 py-2 rounded-full text-sm font-bold text-white/50 hover:text-white transition-all";
            }
            
            // Refresh data when switching tabs
            syncData();
        }

        function switchAdminSubTab(t) {
            // Hide all panels
            document.querySelectorAll('.admin-panel').forEach(p => {
                p.classList.add('hidden');
            });
            
            // Show selected panel
            const panel = document.getElementById(`admin-panel-${t}`);
            if (panel) {
                panel.classList.remove('hidden');
            }
            
            // Update button styles
            document.querySelectorAll('.menu-btn').forEach(b => {
                b.className = "menu-btn glass-ios hover:bg-white/10 text-white/70 rounded-2xl py-3 font-bold";
            });
            
            const activeBtn = document.getElementById(`menu-${t}`);
            if (activeBtn) {
                activeBtn.className = "menu-btn btn-blue rounded-2xl py-3 font-bold shadow-lg text-white";
            }
            
            refreshUI();
        }

        function refreshDropdowns() {
            const setOpts = (id, list) => {
                const el = document.getElementById(id);
                if (!el) return;
                
                const cur = el.value;
                el.innerHTML = '<option value="">-- เลือก --</option>';
                
                list.forEach(i => {
                    const o = document.createElement('option');
                    o.value = i.id;
                    o.textContent = i.name || 'ไม่มีชื่อ';
                    el.appendChild(o);
                });
                
                if (cur) el.value = cur;
            };
            
            setOpts('class-subject-ref', dataState.subjects);
            setOpts('student-class', dataState.classes);
            setOpts('scan-class-select', dataState.classes);
            setOpts('task-subject-filter', dataState.subjects);
            setOpts('att-class-select', dataState.classes);
            setOpts('mat-subject', dataState.subjects);
            setOpts('sch-class', dataState.classes);
            setOpts('report-subject', dataState.subjects);
        }

        function updateReportClassDropdown() {
            const subId = document.getElementById('report-subject')?.value;
            const classSelect = document.getElementById('report-class');
            
            if (!classSelect) return;
            
            classSelect.innerHTML = '<option value="">-- เลือกห้อง --</option>';
            document.getElementById('report-table-body').innerHTML = '';
            
            if (!subId) return;
            
            const filteredClasses = dataState.classes.filter(c => c.subjectId == subId);
            filteredClasses.forEach(c => {
                const o = document.createElement('option');
                o.value = c.id;
                o.textContent = c.name;
                classSelect.appendChild(o);
            });
        }

        function updateScanTaskDropdown() {
            const cid = document.getElementById('scan-class-select')?.value;
            const el = document.getElementById('scan-task-select');
            
            if (!el) return;
            
            const currentTaskId = el.value;
            el.innerHTML = '<option value="">-- เลือกงาน --</option>';
            
            const classTasks = dataState.tasks.filter(t => t.classId == cid);
            classTasks.reverse().forEach(t => {
                const o = document.createElement('option');
                o.value = t.id;
                o.textContent = `${t.name} (Max ${t.maxScore})`;
                el.appendChild(o);
            });
            
            if (currentTaskId) el.value = currentTaskId;
        }

        function renderTaskClassCheckboxes() {
            const subId = document.getElementById('task-subject-filter')?.value;
            const div = document.getElementById('task-class-checkboxes');
            
            if (!div) return;
            
            div.innerHTML = '';
            
            if (!subId) return;
            
            const filteredClasses = dataState.classes.filter(c => c.subjectId == subId);
            filteredClasses.forEach(c => {
                const lbl = document.createElement('label');
                lbl.className = "flex items-center gap-2 p-2 rounded hover:bg-white/10 cursor-pointer";
                lbl.innerHTML = `<input type="checkbox" value="${c.id}" class="accent-yellow-500 w-4 h-4 rounded">
                                <span class="text-xs text-white/80">${c.name}</span>`;
                div.appendChild(lbl);
            });
        }

        function renderScoreButtons() {
            const container = document.getElementById('score-buttons-container');
            if (!container) return;
            
            container.innerHTML = '';
            [5, 6, 7, 8, 9, 10].forEach(i => {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = "btn-score py-2 rounded-lg border border-white/20 bg-white/5 text-white hover:bg-white/10";
                button.onclick = () => setScoreMode(i);
                container.appendChild(button);
            });
        }

        function setScoreMode(m) {
            scoreMode = m;
            
            document.querySelectorAll('.btn-score').forEach(b => {
                b.classList.remove('btn-score-active');
                if (b.textContent == m) {
                    b.classList.add('btn-score-active');
                }
            });
            
            const manualButton = document.getElementById('btn-score-manual');
            if (manualButton) {
                if (m == 'manual') {
                    manualButton.classList.add('btn-score-active');
                } else {
                    manualButton.classList.remove('btn-score-active');
                }
            }
            
            const scanInput = document.getElementById('scan-score-input');
            if (scanInput) scanInput.focus();
        }

        // RENDER FUNCTIONS
        function renderAttRoster() {
            const cid = document.getElementById('att-class-select')?.value;
            const div = document.getElementById('att-roster-grid');
            const dateInput = document.getElementById('att-date-input');
            
            if (!div) return;
            
            div.innerHTML = '';
            if (!cid) return;
            
            const date = dateInput ? dateInput.value : getThaiDateISO();
            let p = 0, l = 0, a = 0;
            
            const students = dataState.students
                .filter(s => s.classId == cid)
                .sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
            
            students.forEach(s => {
                const log = dataState.attendance.find(a => 
                    a.studentId == s.id && (a.date == date || (a.date && a.date.substring(0, 10) == date))
                );
                
                const st = log ? log.status : 'none';
                if (st == 'มา') p++;
                if (st == 'ลา') l++;
                if (st == 'ขาด') a++;
                
                let statusClass = '';
                if (st == 'มา') {
                    statusClass = 'status-done';
                } else if (st == 'ลา') {
                    statusClass = 'bg-yellow-500/20 border-yellow-500 text-yellow-500';
                } else if (st == 'ขาด') {
                    statusClass = 'bg-red-500/20 border-red-500 text-red-500';
                } else {
                    statusClass = 'status-none';
                }
                
                const el = document.createElement('div');
                el.className = `status-box ${statusClass} p-3 flex flex-col items-center justify-center cursor-pointer border`;
                el.onclick = () => {
                    if (attMode) {
                        saveAndRefresh({
                            action: 'addAttendance',
                            studentId: s.id,
                            classId: cid,
                            date: date,
                            status: attMode
                        });
                    }
                };
                
                el.innerHTML = `
                    <div class="text-xs opacity-70">No. ${s.no || '?'}</div>
                    <div class="font-bold text-center text-sm">${s.name || 'ไม่มีชื่อ'}</div>
                    <div class="text-[10px] mt-1">${st}</div>
                `;
                
                div.appendChild(el);
            });
            
            // Update statistics
            document.getElementById('stat-present').textContent = p;
            document.getElementById('stat-leave').textContent = l;
            document.getElementById('stat-absent').textContent = a;
        }

        function setAttMode(m) {
            attMode = m;
            
            // Remove active classes from all buttons
            document.getElementById('btn-att-present').classList.remove('btn-att-active-present');
            document.getElementById('btn-att-leave').classList.remove('btn-att-active-leave');
            document.getElementById('btn-att-absent').classList.remove('btn-att-active-absent');
            
            // Add active class to selected button
            if (m == 'มา') {
                document.getElementById('btn-att-present').classList.add('btn-att-active-present');
            } else if (m == 'ลา') {
                document.getElementById('btn-att-leave').classList.add('btn-att-active-leave');
            } else if (m == 'ขาด') {
                document.getElementById('btn-att-absent').classList.add('btn-att-active-absent');
            }
            
            // Focus on scan input
            const scanInput = document.getElementById('att-scan-input');
            if (scanInput) scanInput.focus();
        }

        function renderAdminMaterials() {
            const div = document.getElementById('admin-mat-list');
            if (!div) return;
            
            div.innerHTML = '';
            
            dataState.materials.forEach(m => {
                const sub = dataState.subjects.find(s => s.id == m.subjectId)?.name || '-';
                const el = document.createElement('div');
                el.className = "bg-white/5 p-3 rounded-xl border border-white/10 flex justify-between";
                el.innerHTML = `
                    <div>
                        <div class="text-xs text-yellow-400">${sub}</div>
                        <div class="font-bold text-sm text-white">
                            <a href="${m.link}" target="_blank" class="hover:underline">${m.title}</a>
                        </div>
                    </div>
                `;
                div.appendChild(el);
            });
        }

        // Student Functionality
        function handleStudentLogin() {
            if (!Array.isArray(dataState.students) || dataState.students.length === 0) {
                showToast("⚠️ ระบบกำลังโหลดข้อมูล... กรุณารอสักครู่", "bg-yellow-600");
                setTimeout(syncData, 500);
                return;
            }
            
            const codeInput = document.getElementById('student-login-id');
            if (!codeInput) return;
            
            const code = codeInput.value.trim();
            if (!code) {
                showToast("กรุณากรอกรหัสนักเรียน", "bg-yellow-600");
                return;
            }
            
            // Show loading spinner
            const spinner = document.getElementById('student-login-spinner');
            if (spinner) spinner.classList.remove('hidden');
            
            // Find student
            let student = dataState.students.find(x => x.code == code);
            if (!student) {
                const looseMatch = dataState.students.find(x => Number(x.code) == Number(code));
                if (looseMatch) {
                    student = looseMatch;
                }
            }
            
            if (!student) {
                if (spinner) spinner.classList.add('hidden');
                showToast(`❌ ไม่พบรหัสนักเรียน: ${code}`, "bg-red-600");
                return;
            }
            
            // Hide spinner
            if (spinner) spinner.classList.add('hidden');
            
            // Save and show dashboard
            localStorage.setItem('current_student_code', code);
            document.getElementById('student-login-wrapper').classList.add('hidden');
            document.getElementById('student-dashboard').classList.remove('hidden');
            
            document.getElementById('std-dash-name').textContent = student.name || 'ไม่มีชื่อ';
            const className = dataState.classes.find(cls => cls.id == student.classId)?.name || '-';
            document.getElementById('std-dash-class').textContent = "Class: " + className;
            
            renderStudentDashboard(student);
        }

        function renderStudentDashboard(s) {
            const container = document.getElementById('std-subjects-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            const myTasks = dataState.tasks.filter(t => t.classId == s.classId);
            const subjectsFound = [...new Set(myTasks.map(t => t.subjectId))];
            const today = getThaiDateISO();
            
            if (subjectsFound.length === 0) {
                container.innerHTML = '<div class="text-center text-white/50 py-10">ไม่มีวิชาที่ลงทะเบียน</div>';
                return;
            }
            
            subjectsFound.forEach(subId => {
                const subj = dataState.subjects.find(sub => sub.id == subId) || { name: '-', scoreConfig: [] };
                const config = (subj.scoreConfig && subj.scoreConfig.length > 0) 
                    ? subj.scoreConfig 
                    : Array(5).fill(10);
                
                const subjectTasks = myTasks.filter(t => t.subjectId == subId);
                const { chapScores, midterm, final, total } = calculateScores(s.id, s.classId, subjectTasks);
                const grade = calGrade(total);
                
                // Create subject card
                const card = document.createElement('div');
                card.className = "glass-ios p-5 rounded-3xl border border-white/10 relative overflow-hidden";
                
                let html = `<h3 class="font-bold text-lg text-white mb-3 border-l-4 border-yellow-500 pl-3 flex justify-between items-center">
                               ${subj.name} <span class="text-sm bg-white/10 px-2 py-1 rounded-lg font-normal text-white/60">เกรด ${grade}</span>
                           </h3>`;
                
                // Dynamic score table
                let th = '', td = '';
                config.forEach((m, i) => {
                    th += `<th class="p-2">C${i + 1}</th>`;
                    td += `<td class="p-2 font-mono text-yellow-400">${chapScores[i] || 0}</td>`;
                });
                
                html += `<div class="overflow-x-auto mb-4 bg-black/20 rounded-xl border border-white/5">
                            <table class="w-full text-sm text-center text-white/80">
                                <thead class="bg-white/5 text-xs text-white/50">
                                    <tr>${th}
                                        <th class="p-2 text-blue-400">Mid</th>
                                        <th class="p-2 text-red-400">Final</th>
                                        <th class="p-2 text-white bg-white/5">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>${td}
                                        <td class="p-2 text-blue-300 font-bold">${midterm}</td>
                                        <td class="p-2 text-red-300 font-bold">${final}</td>
                                        <td class="p-2 text-white font-bold bg-white/10">${total}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>`;
                
                // Task grid
                html += `<div class="mt-2">
                            <h4 class="text-xs text-white/50 mb-2 font-bold">สถานะงาน</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2 max-h-60 overflow-y-auto pr-1">`;
                
                subjectTasks.forEach(t => {
                    const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == t.id);
                    const submission = dataState.submissions.find(x => x.studentId == s.id && x.taskId == t.id);
                    const returned = dataState.returns ? 
                        dataState.returns.find(x => x.studentId == s.id && x.taskId == t.id) : null;
                    
                    let statusClass = "";
                    let statusText = "";
                    let icon = "";
                    let actionBtn = "";
                    
                    if (returned) {
                        statusClass = "bg-orange-500/20 border-orange-500 text-orange-400 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all shadow-[0_0_10px_rgba(249,115,22,0.3)]";
                        statusText = "ต้องแก้ไข";
                        icon = `<i class="fa-solid fa-triangle-exclamation mb-1 text-2xl animate-pulse"></i>`;
                        actionBtn = `<button onclick="openSubmitModal('${t.id}', '${s.id}', '${t.name}')" class="mt-2 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg w-full shadow-lg">แก้ใหม่</button>`;
                    } else if (sc) {
                        statusClass = "bg-green-500/10 border-green-500 text-green-400 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                        statusText = `${sc.score}`;
                        icon = `<i class="fa-solid fa-check-circle mb-1"></i>`;
                    } else if (submission) {
                        statusClass = "bg-blue-500/10 border-blue-500 text-blue-400 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                        statusText = "รอตรวจ";
                        icon = `<i class="fa-solid fa-hourglass-half mb-1"></i>`;
                        actionBtn = `<button onclick="openSubmitModal('${t.id}', '${s.id}', '${t.name}')" class="mt-2 bg-blue-600/50 hover:bg-blue-500 text-white text-[10px] px-2 py-1 rounded w-full border border-blue-400/30">แก้ไข/ส่งซ้ำ</button>`;
                    } else if (t.dueDateISO && t.dueDateISO < today) {
                        statusClass = "bg-red-500/10 border-red-500 text-red-400 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                        statusText = "ขาดส่ง";
                        icon = `<i class="fa-solid fa-circle-exclamation mb-1"></i>`;
                        actionBtn = `<button onclick="openSubmitModal('${t.id}', '${s.id}', '${t.name}')" class="mt-2 bg-red-700 hover:bg-red-600 text-white text-[10px] px-2 py-1 rounded w-full">ส่ง(ช้า)</button>`;
                    } else {
                        statusClass = "bg-white/5 border-white/20 text-white/50 border rounded-xl p-3 flex flex-col items-center justify-center text-center transition-all";
                        statusText = "รอส่ง";
                        icon = `<i class="fa-regular fa-clock mb-1"></i>`;
                        actionBtn = `<button onclick="openSubmitModal('${t.id}', '${s.id}', '${t.name}')" class="mt-2 bg-white/10 hover:bg-white/20 text-white text-[10px] px-2 py-1 rounded w-full">ส่งงาน</button>`;
                    }
                    
                    html += `<div class="${statusClass}">
                                <div class="text-[10px] text-white/30 absolute top-2 right-2">${t.category || '-'}</div>
                                <div class="text-lg mt-1">${icon}</div>
                                <div class="text-xs font-bold truncate w-full px-1 mb-1">${t.name || 'ไม่มีชื่อ'}</div>
                                <div class="text-sm font-bold bg-black/20 px-2 rounded mt-1">${statusText}</div>
                                ${actionBtn}
                            </div>`;
                });
                
                html += `</div></div>`;
                card.innerHTML = html;
                container.appendChild(card);
            });
            
            // Attendance history
            const attendanceBody = document.getElementById('std-att-body');
            if (attendanceBody) {
                attendanceBody.innerHTML = '';
                const atts = dataState.attendance
                    .filter(a => a.studentId == s.id)
                    .sort((a, b) => b.date.localeCompare(a.date));
                
                if (atts.length === 0) {
                    attendanceBody.innerHTML = `<tr><td colspan="2" class="px-3 py-4 text-center text-white/50">ไม่มีประวัติการเข้าเรียน</td></tr>`;
                } else {
                    atts.forEach(a => {
                        const statusColor = a.status == 'มา' ? 'text-green-400' : 
                                          (a.status == 'ลา' ? 'text-yellow-400' : 'text-red-400');
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="px-3 py-2 text-white/50 font-mono text-xs">${formatThaiDate(a.date)}</td>
                            <td class="px-3 py-2 text-center font-bold ${statusColor} text-xs">${a.status}</td>
                        `;
                        attendanceBody.appendChild(tr);
                    });
                }
            }
        }

        function openSubmitModal(tid, sid, tname) {
            const modal = document.getElementById('submit-modal');
            if (!modal) return;
            
            document.getElementById('submit-task-id').value = tid;
            document.getElementById('submit-student-id').value = sid;
            document.getElementById('submit-modal-title').textContent = "งาน: " + (tname || 'ไม่มีชื่อ');
            
            const feedbackBox = document.getElementById('modal-feedback-display');
            const feedbackText = document.getElementById('modal-feedback-text');
            const linkInput = document.getElementById('submit-link-input');
            const commentInput = document.getElementById('submit-comment-input');
            
            if (feedbackBox) feedbackBox.classList.add('hidden');
            if (linkInput) linkInput.value = "";
            if (commentInput) commentInput.value = "";
            
            const searchInput = document.getElementById('friend-search');
            if (searchInput) searchInput.value = "";
            
            // Check for returned work
            const returned = dataState.returns ? 
                dataState.returns.find(r => r.studentId == sid && r.taskId == tid) : null;
            
            if (returned && feedbackBox && feedbackText) {
                feedbackBox.classList.remove('hidden');
                feedbackText.textContent = returned.comment || "(ไม่มีข้อความระบุเหตุผล)";
            }
            
            // Pre-fill existing submission
            const existingSub = dataState.submissions.find(s => s.studentId == sid && s.taskId == tid);
            if (existingSub && linkInput) {
                linkInput.value = existingSub.link || "";
                if (commentInput) {
                    commentInput.value = existingSub.comment || "";
                }
            }
            
            // Friend selector
            const container = document.getElementById('friend-selector-container');
            if (container) {
                container.innerHTML = '';
                const currentStudent = dataState.students.find(s => s.id == sid);
                
                if (currentStudent) {
                    const friends = dataState.students
                        .filter(s => s.classId == currentStudent.classId && s.id != sid)
                        .sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
                    
                    if (friends.length === 0) {
                        container.innerHTML = '<div class="text-xs text-white/30 text-center">- ไม่มีรายชื่อเพื่อน -</div>';
                    } else {
                        friends.forEach(f => {
                            const div = document.createElement('div');
                            div.className = "friend-item flex items-center gap-2 bg-black/20 p-2 rounded hover:bg-white/5 cursor-pointer border border-transparent hover:border-blue-500/50";
                            div.innerHTML = `
                                <input type="checkbox" id="friend-${f.id}" value="${f.id}" class="accent-blue-500 w-4 h-4 rounded cursor-pointer friend-checkbox">
                                <label for="friend-${f.id}" class="text-xs text-white/70 cursor-pointer select-none flex-1">
                                    <span class="font-bold text-white mr-1">${f.no || '?'}.</span> ${f.name || 'ไม่มีชื่อ'}
                                </label>
                            `;
                            container.appendChild(div);
                        });
                    }
                }
            }
            
            modal.classList.remove('hidden');
        }

        // Initialize Event Listeners
        function initEventListeners() {
            // Friend search
            const friendSearch = document.getElementById('friend-search');
            if (friendSearch) {
                friendSearch.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    document.querySelectorAll('.friend-item').forEach(item => {
                        const text = item.textContent.toLowerCase();
                        item.style.display = text.includes(term) ? 'flex' : 'none';
                    });
                });
            }
            
            // Submit work form
            const submitForm = document.getElementById('form-submit-work');
            if (submitForm) {
                submitForm.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    const btn = document.getElementById('btn-submit-final');
                    if (!btn) return;
                    
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังส่ง...';
                    
                    const tid = document.getElementById('submit-task-id').value;
                    const sid = document.getElementById('submit-student-id').value;
                    const linkInput = document.getElementById('submit-link-input');
                    const commentInput = document.getElementById('submit-comment-input');
                    
                    if (!linkInput || !linkInput.value.trim()) {
                        showToast("กรุณาระบุลิงก์งาน", "bg-yellow-600");
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        return;
                    }
                    
                    const link = linkInput.value.trim();
                    const comment = commentInput ? commentInput.value.trim() : "";
                    
                    const checkboxes = document.querySelectorAll('.friend-checkbox:checked');
                    let allStudentIds = [sid];
                    checkboxes.forEach(cb => allStudentIds.push(cb.value));
                    
                    try {
                        await saveAndRefresh({
                            action: 'submitTask',
                            taskId: tid,
                            studentIds: allStudentIds,
                            link: link,
                            comment: comment
                        });
                        
                        document.getElementById('submit-modal').classList.add('hidden');
                        showToast("ส่งงานเรียบร้อย");
                        
                        const student = dataState.students.find(x => x.id == sid);
                        if (student) renderStudentDashboard(student);
                    } catch(err) {
                        console.error('Submit error:', err);
                        showToast("เกิดข้อผิดพลาดในการส่งงาน", "bg-red-600");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                };
            }
            
            // Admin login form
            const adminLoginForm = document.getElementById('admin-login-form');
            if (adminLoginForm) {
                adminLoginForm.onsubmit = async (e) => {
                    e.preventDefault();
                    
                    const username = document.getElementById('admin-username')?.value;
                    const password = document.getElementById('admin-password')?.value;
                    
                    if (!username || !password) {
                        showToast("กรุณากรอกชื่อผู้ใช้และรหัสผ่าน", "bg-yellow-600");
                        return;
                    }
                    
                    try {
                        const result = await saveAndRefresh({
                            action: 'login',
                            username: username,
                            password: password
                        });
                        
                        if (result && result.status == 'success') {
                            localStorage.setItem('wany_admin_session', result.token);
                            showAdminPanel();
                            showToast("เข้าสู่ระบบสำเร็จ");
                        } else {
                            showToast("รหัสผิดหรือไม่พบผู้ใช้", "bg-red-600");
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        showToast("เกิดข้อผิดพลาดในการเข้าสู่ระบบ", "bg-red-600");
                    }
                };
            }
            
            // Task form
            const taskForm = document.getElementById('form-task');
            if (taskForm) {
                taskForm.onsubmit = (e) => {
                    e.preventDefault();
                    
                    const classCbs = document.querySelectorAll('#task-class-checkboxes input:checked');
                    const chapCbs = document.querySelectorAll('.chapter-checkbox:checked');
                    
                    if (classCbs.length === 0) {
                        showToast("กรุณาเลือกห้องเรียน", "bg-yellow-600");
                        return;
                    }
                    
                    const selectedChaps = Array.from(chapCbs).map(cb => cb.value);
                    const cat = document.getElementById('task-category')?.value;
                    
                    if (cat === 'accum' && selectedChaps.length === 0) {
                        showToast("กรุณาเลือกช่องคะแนน", "bg-yellow-600");
                        return;
                    }
                    
                    const taskName = document.getElementById('task-name')?.value;
                    const maxScore = document.getElementById('task-max')?.value || 10;
                    
                    if (!taskName) {
                        showToast("กรุณากรอกชื่องาน", "bg-yellow-600");
                        return;
                    }
                    
                    saveAndRefresh({
                        action: 'addTask',
                        id: Date.now(),
                        classIds: Array.from(classCbs).map(c => c.value),
                        subjectId: document.getElementById('task-subject-filter')?.value,
                        category: cat,
                        chapter: selectedChaps,
                        name: taskName,
                        maxScore: maxScore,
                        dueDateISO: getThaiDateISO()
                    });
                    
                    taskForm.reset();
                    document.querySelectorAll('.chapter-checkbox').forEach(c => c.checked = false);
                    showToast("สร้างงานแล้ว");
                };
            }
            
            // Schedule form
            const scheduleForm = document.getElementById('form-schedule');
            if (scheduleForm) {
                scheduleForm.onsubmit = (e) => {
                    e.preventDefault();
                    saveAndRefresh({
                        action: 'addSchedule',
                        id: Date.now(),
                        day: document.getElementById('sch-day')?.value,
                        period: document.getElementById('sch-period')?.value,
                        classId: document.getElementById('sch-class')?.value
                    });
                    showToast("บันทึกตารางสอนแล้ว");
                };
            }
            
            // Subject form
            const subjectForm = document.getElementById('form-subject');
            if (subjectForm) {
                subjectForm.onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('subject-name')?.value;
                    if (!name) {
                        showToast("กรุณากรอกชื่อวิชา", "bg-yellow-600");
                        return;
                    }
                    saveAndRefresh({ action: 'addSubject', id: Date.now(), name: name });
                    subjectForm.reset();
                    showToast("เพิ่มวิชาแล้ว");
                };
            }
            
            // Class form
            const classForm = document.getElementById('form-class');
            if (classForm) {
                classForm.onsubmit = (e) => {
                    e.preventDefault();
                    const className = document.getElementById('class-name')?.value;
                    const subjectId = document.getElementById('class-subject-ref')?.value;
                    
                    if (!className || !subjectId) {
                        showToast("กรุณากรอกชื่อห้องและเลือกวิชา", "bg-yellow-600");
                        return;
                    }
                    
                    saveAndRefresh({
                        action: 'addClass',
                        id: Date.now(),
                        name: className,
                        subjectId: subjectId
                    });
                    
                    classForm.reset();
                    showToast("เพิ่มห้องเรียนแล้ว");
                };
            }
            
            // Student form
            const studentForm = document.getElementById('form-student');
            if (studentForm) {
                studentForm.onsubmit = (e) => {
                    e.preventDefault();
                    
                    const classId = document.getElementById('student-class')?.value;
                    const studentNo = document.getElementById('student-no')?.value;
                    const studentCode = document.getElementById('student-id')?.value;
                    const studentName = document.getElementById('student-name')?.value;
                    
                    if (!classId || !studentName) {
                        showToast("กรุณากรอกชื่อนักเรียนและเลือกห้องเรียน", "bg-yellow-600");
                        return;
                    }
                    
                    saveAndRefresh({
                        action: 'addStudent',
                        id: Date.now(),
                        classId: classId,
                        no: studentNo || 0,
                        code: studentCode || '',
                        name: studentName
                    });
                    
                    studentForm.reset();
                    showToast("เพิ่มนักเรียนแล้ว");
                };
            }
            
            // Material form
            const materialForm = document.getElementById('form-material');
            if (materialForm) {
                materialForm.onsubmit = (e) => {
                    e.preventDefault();
                    
                    const subjectId = document.getElementById('mat-subject')?.value;
                    const title = document.getElementById('mat-title')?.value;
                    const link = document.getElementById('mat-link')?.value;
                    
                    if (!subjectId || !title || !link) {
                        showToast("กรุณากรอกข้อมูลให้ครบ", "bg-yellow-600");
                        return;
                    }
                    
                    saveAndRefresh({
                        action: 'addMaterial',
                        id: Date.now(),
                        subjectId: subjectId,
                        title: title,
                        type: 'link',
                        link: link
                    });
                    
                    materialForm.reset();
                    showToast("เพิ่มเนื้อหาแล้ว");
                };
            }
            
            // Dropdown change listeners
            const reportClass = document.getElementById('report-class');
            if (reportClass) {
                reportClass.onchange = renderGradeReport;
            }
            
            const reportSubject = document.getElementById('report-subject');
            if (reportSubject) {
                reportSubject.onchange = updateReportClassDropdown;
            }
            
            const scanClass = document.getElementById('scan-class-select');
            if (scanClass) {
                scanClass.onchange = () => {
                    updateScanTaskDropdown();
                    renderScoreRoster();
                };
            }
            
            const scanTask = document.getElementById('scan-task-select');
            if (scanTask) {
                scanTask.onchange = renderScoreRoster;
            }
            
            const attClass = document.getElementById('att-class-select');
            if (attClass) {
                attClass.onchange = renderAttRoster;
            }
            
            const attDate = document.getElementById('att-date-input');
            if (attDate) {
                attDate.onchange = renderAttRoster;
            }
            
            const taskCategory = document.getElementById('task-category');
            if (taskCategory) {
                taskCategory.onchange = (e) => {
                    const chapterWrapper = document.getElementById('chapter-wrapper');
                    if (chapterWrapper) {
                        if (e.target.value === 'accum') {
                            chapterWrapper.classList.remove('hidden');
                        } else {
                            chapterWrapper.classList.add('hidden');
                        }
                    }
                };
            }
            
            // Modal save button
            const modalSaveBtn = document.getElementById('btn-modal-save');
            if (modalSaveBtn) {
                modalSaveBtn.onclick = () => {
                    const input = document.getElementById('modal-score-input');
                    if (!input) return;
                    
                    const val = input.value.trim();
                    if (!val) {
                        showToast("กรุณาใส่คะแนน", "bg-yellow-600");
                        return;
                    }
                    
                    const numericVal = Number(val);
                    if (isNaN(numericVal)) {
                        showToast("กรุณาใส่คะแนนเป็นตัวเลข", "bg-red-600");
                        return;
                    }
                    
                    if (!pendingScore || !pendingScore.s || !pendingScore.t) return;
                    
                    const { s, t } = pendingScore;
                    if (numericVal > Number(t.maxScore)) {
                        showToast("คะแนนเกินคะแนนเต็ม", "bg-red-600");
                        return;
                    }
                    
                    saveAndRefresh({
                        action: 'addScore',
                        studentId: s.id,
                        taskId: t.id,
                        score: numericVal
                    });
                    
                    closeScoreModal();
                    showToast("บันทึกคะแนนแล้ว");
                };
            }
            
            // Modal input enter key
            const modalInput = document.getElementById('modal-score-input');
            if (modalInput) {
                modalInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('btn-modal-save')?.click();
                    }
                };
            }
            
            // Student login enter key
            const studentLoginInput = document.getElementById('student-login-id');
            if (studentLoginInput) {
                studentLoginInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        handleStudentLogin();
                    }
                };
            }
            
            // Scan score input
            const scanScoreInput = document.getElementById('scan-score-input');
            if (scanScoreInput) {
                scanScoreInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        const val = e.target.value.trim();
                        const cid = document.getElementById('scan-class-select')?.value;
                        
                        if (!cid) {
                            showToast("กรุณาเลือกห้องก่อน", "bg-yellow-600");
                            e.target.value = '';
                            return;
                        }
                        
                        const student = dataState.students.find(st => 
                            (st.code == val || st.no == val) && st.classId == cid
                        );
                        
                        if (!student) {
                            showToast(`ไม่พบนักเรียน: ${val}`, "bg-red-600");
                            e.target.value = '';
                            return;
                        }
                        
                        const tid = document.getElementById('scan-task-select')?.value;
                        const task = dataState.tasks.find(x => x.id == tid);
                        
                        if (!task) {
                            showToast("กรุณาเลือกงานก่อน", "bg-yellow-600");
                            e.target.value = '';
                            return;
                        }
                        
                        if (scoreMode !== 'manual') {
                            if (Number(scoreMode) > Number(task.maxScore)) {
                                showToast("คะแนนที่เลือกเกินคะแนนเต็มของงานนี้!", "bg-red-600");
                            } else {
                                saveAndRefresh({
                                    action: 'addScore',
                                    studentId: student.id,
                                    taskId: task.id,
                                    score: scoreMode
                                });
                                showToast(`${student.name} : ${scoreMode} คะแนน`, "bg-green-600");
                            }
                        } else {
                            pendingScore = { s: student, t: task };
                            const modal = document.getElementById('score-modal');
                            if (modal) {
                                modal.classList.remove('hidden');
                                document.getElementById('modal-task-name').textContent = task.name;
                                document.getElementById('modal-student-name').textContent = student.name;
                                document.getElementById('modal-max-score').textContent = task.maxScore;
                                
                                const existingScore = dataState.scores.find(x => 
                                    x.studentId == student.id && x.taskId == task.id
                                );
                                document.getElementById('modal-score-input').value = existingScore ? existingScore.score : '';
                                
                                setTimeout(() => {
                                    const input = document.getElementById('modal-score-input');
                                    if (input) input.focus();
                                }, 100);
                            }
                        }
                        
                        e.target.value = '';
                    }
                };
            }
            
            // Attendance scan input
            const attScanInput = document.getElementById('att-scan-input');
            if (attScanInput) {
                attScanInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        const val = e.target.value.trim();
                        const cid = document.getElementById('att-class-select')?.value;
                        const dateInput = document.getElementById('att-date-input');
                        const date = dateInput ? dateInput.value : getThaiDateISO();
                        const mode = attMode || 'มา';
                        
                        if (!cid) {
                            showToast("กรุณาเลือกห้องก่อน", "bg-yellow-600");
                            e.target.value = '';
                            return;
                        }
                        
                        const student = dataState.students.find(st => 
                            (st.code == val || st.no == val) && st.classId == cid
                        );
                        
                        if (student) {
                            saveAndRefresh({
                                action: 'addAttendance',
                                studentId: student.id,
                                classId: cid,
                                date: date,
                                status: mode
                            });
                            showToast(`${student.name} : ${mode}`, "bg-green-600");
                        } else {
                            showToast(`ไม่พบรหัส: ${val}`, "bg-red-600");
                        }
                        
                        e.target.value = '';
                    }
                };
            }
        }

        // Initialize the app
        initializeApp();
    </script>
</body>
</html>
