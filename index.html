<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสอบออนไลน์ (Krukong Chinese)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
    </style>
    <meta name="google" content="notranslate" />
    <meta http-equiv="Content-Language" content="th" />
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen text-slate-800 notranslate" translate="no">
    <div id="root"></div>

    <script type="text/babel">
        // Icons
        const Icon = ({ path, className, size = 24 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>);
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
        const Clock = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
        const FileText = (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />;
        const Lock = (props) => <Icon {...props} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />;
        const LogOut = (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />;
        const Shield = (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const PlayCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></>} />;
        const StopCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></>} />;
        const PlusCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></>} />;
        const Image = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />;
        const ChevronRight = (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"/>} />;
        const ChevronLeft = (props) => <Icon {...props} path={<polyline points="15 18 9 12 15 6"/>} />;
        const Settings = (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />;
        const Download = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />;
        const Trash = (props) => <Icon {...props} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />;

        const { useState, useEffect, useRef } = React;
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwLqt4BQe17ST8aSNzZy78UXZIGL95n7NWux28VrVoqA14Jk9l76Clz3_I8RcgWrII-/exec";
        const LOGO_URL = "https://img2.pic.in.th/pic/Logoc404dc85753b800c.png";

        // --- Reusable Components ---
        const LogoHeader = ({ title, subtitle, className = "" }) => (
            <div className={`flex flex-col items-center mb-8 ${className}`}>
                <img src={LOGO_URL} alt="Logo" className="w-24 h-auto drop-shadow-md mb-4 animate-float" />
                {title && <h2 className="text-2xl font-bold text-slate-800 text-center">{title}</h2>}
                {subtitle && <p className="text-slate-500 text-sm text-center mt-1">{subtitle}</p>}
            </div>
        );

        const SecureExamApp = () => {
            const [step, setStep] = useState('login'); 
            const [student, setStudent] = useState(null);
            const [studentIdInput, setStudentIdInput] = useState('');
            const [adminPassword, setAdminPassword] = useState('');
            const [exams, setExams] = useState([]);
            const [currentExam, setCurrentExam] = useState(null);
            
            // Admin States
            const [adminTab, setAdminTab] = useState('dashboard');
            const [adminTimeLimitInput, setAdminTimeLimitInput] = useState(5); 
            const [adminClassroomInput, setAdminClassroomInput] = useState('All');
            const [dashboardData, setDashboardData] = useState([]);
            
            // Create Exam Form State
            const [newExam, setNewExam] = useState({ id: '', title: '', time: 60 });
            const [newQuestions, setNewQuestions] = useState([]);
            // Initialize options with 2 empty strings
            const [qDraft, setQDraft] = useState({ text: '', options: ['', ''], correct: 0, mediaType: 'none', mediaContent: '' });

            const [systemConfig, setSystemConfig] = useState({ activeExamId: '', isOpen: false, customTimeLimit: 0, activeClassroom: 'All' });
            
            // Exam Execution
            const [currentQIdx, setCurrentQIdx] = useState(0); 
            const [timeLeft, setTimeLeft] = useState(0);
            const [answers, setAnswers] = useState({});
            const [examStatus, setExamStatus] = useState('pending');
            const [cheatReason, setCheatReason] = useState(null);
            const [score, setScore] = useState(0);
            
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const timerRef = useRef(null);
            const configIntervalRef = useRef(null);

            useEffect(() => {
                fetchExams();
                fetchSystemConfig();
                configIntervalRef.current = setInterval(fetchSystemConfig, 4000);
                return () => clearInterval(configIntervalRef.current);
            }, []);

            const fetchExams = async () => {
                try {
                    const res = await fetch(`${GAS_API_URL}?action=get_exams&t=${Date.now()}`);
                    const data = await res.json();
                    if (Array.isArray(data)) setExams(data);
                } catch (err) { console.error("Failed to fetch exams"); }
            };

            const fetchSystemConfig = async () => {
                try {
                    const res = await fetch(`${GAS_API_URL}?action=get_config&t=${Date.now()}`);
                    const data = await res.json();
                    setSystemConfig({
                        activeExamId: data.active_exam_id,
                        isOpen: data.is_open === 'true' || data.is_open === true,
                        customTimeLimit: parseInt(data.custom_time_limit) || 0,
                        activeClassroom: data.active_classroom || 'All'
                    });
                    if ((data.is_open === 'true' || data.is_open === true) && step === 'waiting_room') setStep('instructions');
                } catch (err) {}
            };

            const handleCreateExamSubmit = async () => {
                if (!newExam.id || !newExam.title || newQuestions.length === 0) {
                    alert("กรุณากรอกข้อมูลให้ครบและเพิ่มข้อสอบอย่างน้อย 1 ข้อ"); return;
                }
                setLoading(true);
                try {
                    await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'create_exam',
                            exam: newExam,
                            questions: newQuestions
                        })
                    });
                    alert("สร้างข้อสอบสำเร็จ!");
                    setNewExam({ id: '', title: '', time: 60 });
                    setNewQuestions([]);
                    setAdminTab('dashboard');
                    fetchExams();
                } catch (err) { alert("เกิดข้อผิดพลาด"); }
                setLoading(false);
            };

            const addQuestionToDraft = () => {
                if (!qDraft.text || qDraft.options.some(o => !o.trim())) {
                    alert("กรุณากรอกคำถามและตัวเลือกให้ครบถ้วน"); return;
                }
                setNewQuestions([...newQuestions, { ...qDraft }]);
                setQDraft({ text: '', options: ['', ''], correct: 0, mediaType: 'none', mediaContent: '' });
            };

            // Dynamic Options Logic
            const addDraftOption = () => {
                setQDraft(prev => ({ ...prev, options: [...prev.options, ''] }));
            };

            const removeDraftOption = (index) => {
                if (qDraft.options.length <= 2) return;
                const newOptions = qDraft.options.filter((_, i) => i !== index);
                let newCorrect = qDraft.correct;
                if (index === qDraft.correct) newCorrect = 0;
                else if (index < qDraft.correct) newCorrect = qDraft.correct - 1;
                
                setQDraft(prev => ({ ...prev, options: newOptions, correct: newCorrect }));
            };
            
            const handleStudentLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try {
                    const res = await fetch(`${GAS_API_URL}?action=check_student&id=${studentIdInput}&t=${Date.now()}`);
                    const data = await res.json();
                    if (data.found) {
                        const sData = { ...data, classroom: String(data.classroom || "").trim(), assignedExams: data.assignedExams || [] };
                        const activeId = String(systemConfig.activeExamId).trim();
                        
                        if (sData.assignedExams.length === 0) { setError('คุณไม่มีสิทธิ์เข้าสอบ (ไม่พบรายชื่อวิชาในทะเบียน)'); setLoading(false); return; }
                        if (activeId && !sData.assignedExams.map(e=>String(e).trim()).includes(activeId)) {
                            const activeExam = exams.find(ex => String(ex.id).trim() === activeId);
                            const examTitle = activeExam ? activeExam.title : activeId;
                            setError(`คุณไม่มีสิทธิ์สอบวิชานี้: ${examTitle} (รหัส: ${activeId})`); setLoading(false); return;
                        }
                        const cfgRoom = String(systemConfig.activeClassroom || 'All').trim();
                        if (cfgRoom !== 'All' && cfgRoom !== sData.classroom) {
                            setError(`เปิดสอบเฉพาะห้อง ${cfgRoom} (คุณอยู่ห้อง ${sData.classroom})`); setLoading(false); return;
                        }
                        setStudent(sData);
                        if (systemConfig.isOpen) { prepareExam(activeId); setStep('instructions'); }
                        else setStep('waiting_room');
                    } else setError('ไม่พบรหัสนักเรียนในระบบ');
                } catch (err) { setError('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้'); }
                setLoading(false);
            };

            const prepareExam = (examId) => {
                const cleanExamId = String(examId).trim();
                const found = exams.find(e => String(e.id).trim() === cleanExamId);
                if (found) {
                    const effectiveTime = systemConfig.customTimeLimit > 0 ? systemConfig.customTimeLimit : found.timeLimit;
                    setCurrentExam({ ...found, timeLimit: effectiveTime });
                } else {
                    setCurrentExam({ id: cleanExamId, title: "กำลังโหลดข้อมูล...", timeLimit: systemConfig.customTimeLimit || 300, questions: [] });
                }
            };

            useEffect(() => {
                if (step === 'waiting_room' && systemConfig.isOpen && systemConfig.activeExamId) {
                    const configClassroom = String(systemConfig.activeClassroom || 'All').trim();
                    if(configClassroom === 'All' || configClassroom === String(student.classroom).trim()) {
                        prepareExam(systemConfig.activeExamId);
                        setStep('instructions');
                    }
                }
            }, [systemConfig, step, student]);

            const startExam = () => {
                if (!systemConfig.isOpen) { alert("ระบบปิดแล้ว"); window.location.reload(); return; }
                setTimeLeft(currentExam.timeLimit);
                setStep('exam');
                setExamStatus('active');
                setCurrentQIdx(0);
                timerRef.current = setInterval(() => {
                    setTimeLeft(p => { if(p<=1) { submitExam('TimeOut'); return 0; } return p-1; });
                }, 1000);
            };

            const submitExam = async (reason = 'Normal', isCheat = false) => {
                clearInterval(timerRef.current);
                let score = 0;
                if(currentExam && currentExam.questions) currentExam.questions.forEach(q => { if(answers[q.id] === q.correct) score++; });
                setScore(score); setStep('result'); if(!isCheat) setExamStatus('submitted');
                try {
                    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({
                        action: 'submit_exam', studentId: student.id, studentName: `${student.name} ${student.surname}`,
                        examId: currentExam.id, score, totalScore: currentExam.questions.length, status: isCheat?'CHEATED':'COMPLETED', reason, answers
                    })});
                } catch(e) {}
            };

            // Anti-Cheat (Tab Switch)
            useEffect(() => {
                if (step !== 'exam') return;
                const handleVis = () => { if(document.hidden) handleCheatDetection('สลับหน้าจอ (Tab Switch)'); };
                document.addEventListener('visibilitychange', handleVis);
                return () => document.removeEventListener('visibilitychange', handleVis);
            }, [step]);

            const handleCheatDetection = (reason) => {
                if(examStatus==='submitted'||examStatus==='cheated') return;
                setCheatReason(reason); setExamStatus('cheated'); submitExam(reason, true);
            };

            // Admin Logic
            const fetchDashboardData = async () => {
                setLoading(true); try { const r = await fetch(`${GAS_API_URL}?action=get_dashboard_data&t=${Date.now()}`); const d = await r.json(); if(d.students) setDashboardData(d.students); } catch(e){} setLoading(false);
            };
            const handleAdminLogin = async (e) => {
                e.preventDefault(); setLoading(true);
                try { const r = await fetch(`${GAS_API_URL}?action=check_admin&password=${adminPassword}`); const d = await r.json();
                if(d.valid) { setStep('admin_dashboard'); fetchDashboardData(); } else setError('รหัสผิด'); } catch(e){ setError('Error'); } setLoading(false);
            };
            const handleToggle = async (open) => {
                setLoading(true); try { 
                    if(open) {
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'custom_time_limit', value: adminTimeLimitInput*60 }) });
                        await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'active_classroom', value: adminClassroomInput }) });
                    }
                    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'is_open', value: open }) });
                    await fetchSystemConfig();
                } catch(e){} setLoading(false);
            };
            const handleChangeSub = async (id) => {
                setLoading(true); try {
                    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'is_open', value: false }) });
                    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'active_exam_id', value: id }) });
                    await fetchSystemConfig();
                } catch(e){} setLoading(false);
            };

            // --- UI Renders ---

            const renderCreateExam = () => (
                <div className="space-y-6">
                    <div className="bg-sky-50 p-6 rounded-xl border border-sky-100">
                        <h3 className="font-bold text-sky-800 mb-4 flex items-center gap-2"><Settings size={18}/> 1. ข้อมูลชุดข้อสอบ</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" placeholder="รหัสวิชา (เช่น ENG01)" value={newExam.id} onChange={e=>setNewExam({...newExam, id: e.target.value})} className="p-3 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none" />
                            <input type="text" placeholder="ชื่อวิชา" value={newExam.title} onChange={e=>setNewExam({...newExam, title: e.target.value})} className="p-3 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none" />
                            <input type="number" placeholder="เวลาสอบ (นาที)" value={newExam.time} onChange={e=>setNewExam({...newExam, time: e.target.value})} className="p-3 border border-sky-200 rounded-lg focus:ring-2 focus:ring-sky-400 outline-none" />
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><PlusCircle size={18}/> 2. เพิ่มข้อสอบ (ข้อที่ {newQuestions.length + 1})</h3>
                        <div className="mb-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <label className="text-sm font-semibold text-gray-600 block mb-2">สื่อประกอบ (ก่อนคำถาม)</label>
                            <div className="flex gap-2 mb-2">
                                <select value={qDraft.mediaType} onChange={e=>setQDraft({...qDraft, mediaType: e.target.value})} className="p-2 border rounded-lg text-sm bg-white">
                                    <option value="none">ไม่มี</option>
                                    <option value="image">รูปภาพ/กราฟ (URL)</option>
                                    <option value="text_box">บทความ/กล่องข้อความ</option>
                                </select>
                                {qDraft.mediaType !== 'none' && (
                                    <input 
                                        type="text" 
                                        placeholder={qDraft.mediaType === 'image' ? "วางลิงก์รูปภาพ..." : "พิมพ์ข้อความ..."}
                                        value={qDraft.mediaContent} 
                                        onChange={e=>setQDraft({...qDraft, mediaContent: e.target.value})}
                                        className="flex-1 p-2 border rounded-lg text-sm focus:ring-1 focus:ring-sky-400 outline-none"
                                    />
                                )}
                            </div>
                            {qDraft.mediaType === 'image' && qDraft.mediaContent && (
                                <img src={qDraft.mediaContent} alt="Preview" className="h-40 object-contain mx-auto border bg-white rounded shadow-sm" onError={(e)=>e.target.style.display='none'}/>
                            )}
                        </div>

                        <input type="text" placeholder="คำถาม..." value={qDraft.text} onChange={e=>setQDraft({...qDraft, text: e.target.value})} className="w-full p-3 border border-gray-300 rounded-lg mb-4 font-medium focus:ring-2 focus:ring-sky-400 outline-none" />
                        
                        <div className="mb-4 space-y-3">
                            {qDraft.options.map((opt, i) => (
                                <div key={i} className="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border">
                                    <input type="radio" name="correct_draft" className="w-4 h-4 text-sky-600" checked={qDraft.correct === i} onChange={()=>setQDraft({...qDraft, correct: i})} />
                                    <input type="text" placeholder={`ตัวเลือก ${i+1}`} value={opt} onChange={e=>{const newO=[...qDraft.options]; newO[i]=e.target.value; setQDraft({...qDraft, options: newO})}} className="flex-1 p-2 bg-transparent outline-none text-sm" />
                                    {qDraft.options.length > 2 && (
                                        <button onClick={() => removeDraftOption(i)} className="p-1 text-slate-400 hover:text-red-500 rounded"><Trash size={16}/></button>
                                    )}
                                </div>
                            ))}
                            <button onClick={addDraftOption} className="text-sm text-sky-600 font-bold hover:underline flex items-center gap-1"><PlusCircle size={14}/> เพิ่มตัวเลือก</button>
                        </div>
                        <button onClick={addQuestionToDraft} className="bg-sky-600 text-white px-5 py-2 rounded-lg text-sm font-semibold hover:bg-sky-700 shadow flex items-center gap-2"><PlusCircle size={16}/> เพิ่มข้อสอบลงรายการ</button>
                    </div>

                    <div className="border-t pt-6">
                        <h4 className="font-bold text-gray-600 mb-4">รายการข้อสอบที่จะบันทึก ({newQuestions.length} ข้อ)</h4>
                        <div className="max-h-60 overflow-y-auto space-y-2 mb-6 pr-2">
                            {newQuestions.map((q, i) => (
                                <div key={i} className="text-sm p-3 bg-white border border-gray-200 rounded-lg flex justify-between items-center shadow-sm">
                                    <span className="truncate flex-1 font-medium text-slate-700">{i+1}. {q.text} <span className="text-xs text-gray-400">({q.options.length} ตัวเลือก)</span> {q.mediaType!=='none' && <span className="text-xs bg-sky-100 text-sky-600 px-2 py-0.5 rounded-full ml-2">มีสื่อ</span>}</span>
                                    <button onClick={()=>setNewQuestions(newQuestions.filter((_, idx)=>idx!==i))} className="text-red-500 hover:text-red-700 text-xs font-bold border border-red-200 px-2 py-1 rounded">ลบ</button>
                                </div>
                            ))}
                        </div>
                        <button onClick={handleCreateExamSubmit} disabled={loading || newQuestions.length===0} className="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white py-3 rounded-xl font-bold hover:from-emerald-600 hover:to-green-700 shadow-lg transform transition active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
                            {loading ? 'กำลังบันทึกข้อมูล...' : 'บันทึกชุดข้อสอบลงระบบ'}
                        </button>
                    </div>
                </div>
            );

            const renderSingleQuestion = () => {
                const q = currentExam.questions[currentQIdx];
                return (
                    <div className="max-w-4xl mx-auto px-4 py-8">
                        <div className="flex justify-between items-center mb-6 text-sm font-medium text-slate-600 bg-white px-4 py-2 rounded-full shadow-sm">
                            <span>ข้อที่ {currentQIdx + 1} / {currentExam.questions.length}</span>
                            <div className="w-48 bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                <div className="bg-gradient-to-r from-sky-500 to-blue-600 h-2.5 rounded-full transition-all duration-300" style={{width: `${((currentQIdx+1)/currentExam.questions.length)*100}%`}}></div>
                            </div>
                        </div>

                        <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 relative overflow-hidden">
                            {/* Decorative Blob */}
                            <div className="absolute -top-10 -right-10 w-32 h-32 bg-sky-50 rounded-full blur-2xl opacity-50 pointer-events-none"></div>

                            {q.mediaType === 'image' && q.mediaContent && (
                                <div className="mb-8 flex justify-center bg-slate-50 p-4 rounded-xl border border-slate-100">
                                    <img src={q.mediaContent} alt="Media" className="max-h-80 max-w-full object-contain rounded shadow-sm" />
                                </div>
                            )}
                            {q.mediaType === 'text_box' && q.mediaContent && (
                                <div className="mb-8 p-6 bg-amber-50 border border-amber-100 rounded-xl text-slate-800 text-base whitespace-pre-wrap leading-relaxed shadow-sm">
                                    {q.mediaContent}
                                </div>
                            )}

                            <h3 className="font-bold text-xl md:text-2xl text-slate-800 mb-8 leading-snug">{q.question}</h3>

                            <div className="space-y-4">
                                {q.options.map((opt, optIndex) => (
                                    <label key={optIndex} className={`group flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 ${answers[q.id] === optIndex ? 'bg-sky-50 border-sky-500 shadow-md' : 'border-slate-100 hover:border-sky-200 hover:bg-slate-50'}`}>
                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center mr-4 transition-colors ${answers[q.id] === optIndex ? 'border-sky-600 bg-sky-600' : 'border-slate-300 group-hover:border-sky-400'}`}>
                                            {answers[q.id] === optIndex && <div className="w-2.5 h-2.5 bg-white rounded-full"></div>}
                                        </div>
                                        <input type="radio" className="hidden" name={`q-${q.id}`} checked={answers[q.id] === optIndex} onChange={() => setAnswers({...answers, [q.id]: optIndex})} />
                                        <span className={`text-lg ${answers[q.id] === optIndex ? 'text-sky-900 font-semibold' : 'text-slate-700'}`}>{opt}</span>
                                    </label>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-between mt-8">
                            <button 
                                onClick={() => setCurrentQIdx(prev => Math.max(0, prev - 1))}
                                disabled={currentQIdx === 0}
                                className="px-6 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50 hover:shadow disabled:opacity-50 disabled:shadow-none flex items-center gap-2 transition-all"
                            >
                                <ChevronLeft size={20}/> ข้อก่อนหน้า
                            </button>

                            {currentQIdx < currentExam.questions.length - 1 ? (
                                <button 
                                    onClick={() => setCurrentQIdx(prev => prev + 1)}
                                    className="px-8 py-3 bg-gradient-to-r from-sky-600 to-blue-700 text-white rounded-xl font-bold hover:shadow-lg hover:translate-y-[-2px] flex items-center gap-2 transition-all"
                                >
                                    ข้อถัดไป <ChevronRight size={20}/>
                                </button>
                            ) : (
                                <button 
                                    onClick={() => { if(confirm('ยืนยันการส่งคำตอบ? เมื่อส่งแล้วจะไม่สามารถแก้ไขได้')) submitExam('User Submitted'); }}
                                    className="px-8 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-xl font-bold hover:shadow-lg hover:translate-y-[-2px] transition-all shadow-emerald-200"
                                >
                                    ส่งคำตอบและสิ้นสุดการสอบ
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            // --- Main Views ---
            
            if (step === 'admin_dashboard') {
                return (
                    <div className="min-h-screen p-4 md:p-8">
                        <div className="max-w-6xl mx-auto glass-card rounded-2xl shadow-2xl overflow-hidden min-h-[80vh]">
                            <div className="bg-white/50 p-6 border-b border-white/50 flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-3">
                                    <img src={LOGO_URL} className="w-10 h-auto drop-shadow-sm"/> 
                                    <div>
                                        <h1 className="text-xl font-bold text-slate-800">แผงควบคุมระบบสอบ</h1>
                                        <p className="text-xs text-slate-500">Administrator Panel</p>
                                    </div>
                                </div>
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button onClick={()=>setAdminTab('dashboard')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${adminTab==='dashboard'?'bg-white text-sky-700 shadow-sm':'text-slate-500 hover:text-slate-700'}`}>ควบคุมการสอบ</button>
                                    <button onClick={()=>setAdminTab('create_exam')} className={`px-4 py-2 rounded-md text-sm font-bold transition-all ${adminTab==='create_exam'?'bg-white text-sky-700 shadow-sm':'text-slate-500 hover:text-slate-700'}`}>+ สร้างข้อสอบใหม่</button>
                                </div>
                                <button onClick={()=>{setStep('login'); setAdminPassword('');}} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition"><LogOut size={20}/></button>
                            </div>

                            <div className="p-6 md:p-8">
                                {adminTab === 'create_exam' ? renderCreateExam() : (
                                    <>
                                        <div className="bg-gradient-to-r from-sky-50 to-indigo-50 border border-sky-100 p-6 rounded-xl mb-6 shadow-sm">
                                            <h3 className="font-bold text-sky-900 mb-4 flex items-center gap-2 text-lg"><Settings size={20} className="text-sky-600"/> ตั้งค่าการเปิดสอบ</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                                                <div><label className="block text-xs font-bold text-sky-700 mb-2 uppercase tracking-wide">1. รหัสวิชา</label><select value={systemConfig.activeExamId} onChange={(e)=>handleChangeExamSubject(e.target.value)} className="w-full p-3 border border-sky-200 rounded-xl outline-none bg-white focus:ring-2 focus:ring-sky-400 transition" disabled={systemConfig.isOpen}><option value="" disabled>-- เลือก --</option>{exams.map(e=><option key={e.id} value={e.id}>{e.id} : {e.title}</option>)}</select></div>
                                                <div><label className="block text-xs font-bold text-sky-700 mb-2 uppercase tracking-wide">2. ห้องเรียน</label><select value={adminClassroomInput} onChange={(e)=>setAdminClassroomInput(e.target.value)} className="w-full p-3 border border-sky-200 rounded-xl outline-none bg-white focus:ring-2 focus:ring-sky-400 transition" disabled={systemConfig.isOpen}>{['All', ...new Set(dashboardData.map(d=>d.classroom).filter(Boolean))].sort().map(r=><option key={r} value={r}>{r==='All'?'ทุกห้อง':r}</option>)}</select></div>
                                                <div><label className="block text-xs font-bold text-sky-700 mb-2 uppercase tracking-wide">3. เวลา (นาที)</label><input type="number" value={adminTimeLimitInput} onChange={(e)=>setAdminTimeLimitInput(e.target.value)} className="w-full p-3 border border-sky-200 rounded-xl outline-none text-center font-bold bg-white focus:ring-2 focus:ring-sky-400 transition" disabled={systemConfig.isOpen}/></div>
                                                <div>{systemConfig.isOpen ? <button onClick={()=>handleToggle(false)} className="w-full bg-red-500 hover:bg-red-600 text-white p-3 rounded-xl font-bold shadow-lg shadow-red-200 transition transform hover:-translate-y-0.5">ปิดระบบสอบ</button> : <button onClick={()=>handleToggle(true)} disabled={!systemConfig.activeExamId} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white p-3 rounded-xl font-bold shadow-lg shadow-emerald-200 transition transform hover:-translate-y-0.5 disabled:opacity-50 disabled:shadow-none">เปิดสอบทันที</button>}</div>
                                            </div>
                                        </div>
                                        
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold text-slate-700 text-lg">สถานะผู้เข้าสอบ</h3>
                                            <button onClick={fetchDashboardData} className="text-sm bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 flex items-center gap-2 shadow-sm font-medium"><RefreshCw size={14}/> อัปเดตข้อมูล</button>
                                        </div>
                                        
                                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-semibold uppercase tracking-wider"><tr><th className="p-4">รหัส</th><th className="p-4">ชื่อ-สกุล</th><th className="p-4">ห้อง</th><th className="p-4 text-center">สถานะ</th><th className="p-4 text-center">คะแนน</th></tr></thead>
                                                <tbody className="divide-y divide-slate-100">{dashboardData.filter(d=>(systemConfig.isOpen?systemConfig.activeClassroom:adminClassroomInput)==='All' || String(d.classroom)===String(systemConfig.isOpen?systemConfig.activeClassroom:adminClassroomInput)).map((d,i)=>(<tr key={i} className="hover:bg-slate-50 transition"><td className="p-4 font-mono text-slate-600">{d.id}</td><td className="p-4 font-medium text-slate-800">{d.name} {d.surname}</td><td className="p-4 text-slate-500">{d.classroom}</td><td className="p-4 text-center"><span className={`px-3 py-1 rounded-full text-xs font-bold ${d.status==='COMPLETED'?'bg-emerald-100 text-emerald-700':d.status==='CHEATED'?'bg-red-100 text-red-700':'bg-slate-100 text-slate-500'}`}>{d.status||'รอสอบ'}</span></td><td className="p-4 text-center font-bold text-slate-800">{d.score!==undefined?d.score:'-'}</td></tr>))}</tbody>
                                            </table>
                                            {dashboardData.length === 0 && <div className="p-8 text-center text-slate-400">ไม่พบข้อมูลนักเรียน กรุณากดอัปเดต</div>}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            if (step === 'exam') return (
                <div className="min-h-screen bg-slate-50 pb-24">
                    <div className="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-20 border-b border-slate-200">
                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div><h1 className="font-bold text-slate-800 text-lg line-clamp-1">{currentExam.title}</h1><p className="text-xs text-slate-500 font-medium">ผู้เข้าสอบ: {student.name} {student.surname} ({student.id})</p></div>
                            <div className={`flex items-center gap-2 px-4 py-2 bg-slate-100 rounded-lg font-mono font-bold text-lg shadow-inner ${timeLeft<60?'text-red-600 bg-red-50': 'text-slate-700'}`}><Clock size={20}/> {Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2,'0')}</div>
                        </div>
                    </div>
                    {renderSingleQuestion()}
                </div>
            );

            // --- Enhanced Login & Utility Screens ---
            if (step === 'waiting_room') return (<div className="min-h-screen flex items-center justify-center p-4"><div className="glass-card p-10 rounded-2xl shadow-2xl w-full max-w-md text-center"><LogoHeader title="ห้องพักรอสอบ" subtitle="กรุณารอสักครู่..." /><div className="my-8 relative"><div className="absolute inset-0 bg-sky-200 rounded-full animate-ping opacity-20"></div><div className="relative bg-sky-100 p-6 rounded-full text-sky-600 inline-block"><Clock size={48} className="animate-pulse"/></div></div><div className="bg-white/60 p-5 rounded-xl border border-white/50 mb-6"><p className="text-sm text-slate-500 uppercase tracking-wide font-bold mb-1">วิชาที่จะสอบ</p><p className="font-bold text-xl text-slate-800">{currentExam?.title || 'กำลังโหลดข้อมูล...'}</p><div className="mt-3 flex items-center justify-center gap-2 text-sm text-orange-600 font-medium bg-orange-50 py-1.5 px-3 rounded-full mx-auto w-fit"><span className="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span> รอสัญญาณจากครูผู้คุมสอบ</div></div><button onClick={() => setStep('login')} className="text-slate-400 hover:text-slate-600 text-sm font-medium underline transition">ยกเลิก / ออกจากระบบ</button></div></div>);
            
            if (step === 'login') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-md border border-white/40 relative overflow-hidden">
                        <button onClick={() => { setStep('admin_login'); setError(''); }} className="absolute top-4 right-4 text-slate-400 hover:text-sky-600 transition p-2 hover:bg-sky-50 rounded-full" title="สำหรับครูผู้สอน"><Shield size={20} /></button>
                        <LogoHeader title="เข้าสู่ระบบสอบ" subtitle="กรุณากรอกข้อมูลเพื่อยืนยันตัวตน" />
                        <form onSubmit={handleStudentLogin} className="space-y-5">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-2 ml-1">รหัสประจำตัวนักเรียน</label>
                                <input type="text" value={studentIdInput} onChange={(e) => setStudentIdInput(e.target.value)} className="w-full px-5 py-3 bg-white border border-slate-200 rounded-xl focus:ring-4 focus:ring-sky-100 focus:border-sky-500 outline-none transition-all shadow-sm text-lg" placeholder="กรอกรหัสเลข 4-5 หลัก" required />
                            </div>
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-xl flex items-center gap-3 border border-red-100 animate-pulse"><AlertTriangle size={18} className="shrink-0"/>{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-sky-600 to-blue-700 hover:from-sky-700 hover:to-blue-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-sky-200 transform transition hover:-translate-y-0.5 active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed text-lg">
                                {loading ? 'กำลังตรวจสอบ...' : 'เข้าสู่ระบบ'}
                            </button>
                        </form>
                        <p className="text-center text-slate-400 text-xs mt-8">Secure Exam System v2.0 • Powered by React & GAS</p>
                    </div>
                </div>
            );

            if (step === 'admin_login') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-sm border border-white/40">
                        <LogoHeader title="ผู้ดูแลระบบ" subtitle="เฉพาะครูผู้สอนเท่านั้น" className="mb-6"/>
                        <form onSubmit={handleAdminLogin} className="space-y-4">
                            <input type="password" value={adminPassword} onChange={e=>setAdminPassword(e.target.value)} className="w-full px-5 py-3 bg-white border border-slate-200 rounded-xl focus:ring-4 focus:ring-sky-100 focus:border-sky-500 outline-none transition-all shadow-sm text-center tracking-widest text-lg" placeholder="•••••••" autoFocus/>
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded-lg">{error}</p>}
                            <button className="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg transition transform hover:-translate-y-0.5">เข้าสู่ระบบ (Admin)</button>
                        </form>
                        <button onClick={()=>setStep('login')} className="w-full text-sm text-center mt-6 text-slate-500 hover:text-slate-800 font-medium">กลับหน้าสำหรับนักเรียน</button>
                    </div>
                </div>
            );

            if (step === 'instructions') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="glass-card p-8 rounded-3xl shadow-2xl w-full max-w-lg border border-white/40">
                        <LogoHeader className="mb-2"/>
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3 border-b pb-4"><Lock className="text-amber-500" /> กฎระเบียบห้องสอบ</h2>
                        
                        <div className="bg-sky-50/80 p-5 rounded-2xl mb-6 border border-sky-100">
                             <div className="flex items-center gap-3 mb-2">
                                <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-sky-600 shadow-sm"><User size={20}/></div>
                                <div><p className="text-xs text-sky-600 uppercase font-bold">ผู้เข้าสอบ</p><p className="text-sky-900 font-bold text-lg">{student.name} {student.surname}</p></div>
                             </div>
                             <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-sky-600 shadow-sm"><FileText size={20}/></div>
                                <div><p className="text-xs text-sky-600 uppercase font-bold">วิชาสอบ</p><p className="text-sky-900 font-bold">{currentExam ? currentExam.title : ''}</p></div>
                             </div>
                        </div>

                        <div className="space-y-4 mb-8">
                            <div className="flex items-start gap-4 p-3 hover:bg-red-50 rounded-xl transition cursor-default">
                                <div className="p-2 bg-red-100 text-red-600 rounded-lg"><XCircle size={20}/></div>
                                <div><p className="font-bold text-slate-700">ห้ามสลับหน้าจอ (Tab)</p><p className="text-xs text-slate-500">ระบบจะตรวจจับและตัดสิทธิ์ทันทีหากออกจากหน้าสอบ</p></div>
                            </div>
                            <div className="flex items-start gap-4 p-3 hover:bg-orange-50 rounded-xl transition cursor-default">
                                <div className="p-2 bg-orange-100 text-orange-600 rounded-lg"><AlertTriangle size={20}/></div>
                                <div><p className="font-bold text-slate-700">ห้ามใช้เครื่องมือช่วยแปล</p><p className="text-xs text-slate-500">หากตรวจพบการแปลภาษา ระบบจะยุติการสอบ</p></div>
                            </div>
                            <div className="flex items-start gap-4 p-3 hover:bg-blue-50 rounded-xl transition cursor-default">
                                <div className="p-2 bg-blue-100 text-blue-600 rounded-lg"><Clock size={20}/></div>
                                <div><p className="font-bold text-slate-700">เวลาสอบ {currentExam && currentExam.timeLimit ? currentExam.timeLimit / 60 : '-'} นาที</p><p className="text-xs text-slate-500">ระบบจะส่งคำตอบอัตโนมัติเมื่อหมดเวลา</p></div>
                            </div>
                        </div>
                        <button onClick={startExam} disabled={loading} className="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white text-lg py-4 rounded-2xl font-bold shadow-lg shadow-emerald-200 transform transition hover:-translate-y-1 active:scale-[0.98]">รับทราบและเริ่มทำข้อสอบ</button>
                    </div>
                </div>
            );

            if (step === 'result') { 
                const isCheated = examStatus === 'cheated'; 
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className={`glass-card p-10 rounded-3xl shadow-2xl w-full max-w-md text-center border-t-8 ${isCheated ? 'border-red-500' : 'border-emerald-500'}`}>
                            <LogoHeader className="mb-4"/>
                            <div className="mb-6 flex justify-center">
                                <div className={`p-6 rounded-full shadow-inner ${isCheated ? 'bg-red-50 text-red-500' : 'bg-emerald-50 text-emerald-500'}`}>
                                    {isCheated ? <AlertTriangle size={48} /> : <CheckCircle size={48} />}
                                </div>
                            </div>
                            <h2 className={`text-3xl font-bold mb-2 ${isCheated ? 'text-red-600' : 'text-emerald-700'}`}>{isCheated ? 'ถูกตัดสิทธิ์การสอบ!' : 'ส่งคำตอบเรียบร้อย'}</h2>
                            {isCheated && <div className="bg-red-50 border border-red-200 p-3 rounded-lg mb-6 text-sm text-red-700 font-semibold">สาเหตุ: {cheatReason}</div>}
                            
                            <div className="py-8 border-y border-slate-100 my-6 bg-slate-50/50 rounded-xl">
                                <p className="text-slate-500 text-sm mb-1 uppercase tracking-wide font-bold">ผู้เข้าสอบ</p>
                                <p className="text-slate-800 text-lg font-bold mb-4">{student.name} {student.surname}</p>
                                <div className="flex justify-center items-baseline gap-2">
                                    <span className="text-6xl font-extrabold text-slate-800 drop-shadow-sm">{score}</span>
                                    <span className="text-2xl text-slate-400 font-medium">/ {currentExam.questions ? currentExam.questions.length : 0}</span>
                                </div>
                                <p className="text-slate-400 text-xs mt-2">คะแนนรวมที่ได้</p>
                            </div>
                            
                            <p className="text-slate-500 text-sm mb-8 flex items-center justify-center gap-2"><CheckCircle size={16} className="text-emerald-500"/> บันทึกข้อมูลลงระบบเรียบร้อยแล้ว</p>
                            <button onClick={()=>window.location.reload()} className="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2"><LogOut size={20}/> ออกจากระบบ</button>
                        </div>
                    </div>
                ); 
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SecureExamApp />);
    </script>
</body>
</html>
