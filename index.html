<!doctype html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ChineseClass By Krukong</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: #f1f5f9;
            color: #334155;
        }
        
        /* Luxury Glass & Cards */
        .glass-ios {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.05);
        }
        .luxury-card {
            background: #ffffff;
            border-radius: 16px;
            border: 1px solid #f8fafc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: all 0.2s ease-out;
        }
        .luxury-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            border-color: #e2e8f0;
        }
        
        .glass-input {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            color: #1e293b;
            transition: all 0.3s;
        }
        .glass-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        /* Buttons */
        .btn-primary { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; }
        .btn-primary:hover { box-shadow: 0 8px 20px -4px rgba(37, 99, 235, 0.3); transform: translateY(-1px); }
        
        /* Status Colors */
        .status-done { border-left: 4px solid #10b981; background: #f0fdf4; }
        .status-none { border-left: 4px solid #cbd5e1; }
        
        /* Active States */
        .score-btn-active { background: #3b82f6 !important; color: white !important; transform: scale(1.05); font-weight: 700; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); border: none !important; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Toast Animation */
        #toast-notification { transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        
        /* Utilities */
        .loading-spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: currentColor; animation: spin 1s infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Pending Card (Red) */
        .card-pending { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
        .card-pending button { background: #ef4444; color: white; }
        .card-pending button:hover { background: #dc2626; }

        @media print {
            body { background: white !important; color: black !important; }
            #app-root, .no-print { display: none !important; }
            #print-area { display: block !important; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 5px; text-align: center; }
        }
    </style>
</head>
<body class="w-full h-full min-h-screen text-slate-800 text-sm md:text-base">
    
    <div id="app-root" class="w-full h-full min-h-screen flex items-stretch justify-center p-2 md:p-6">
        <div class="w-full max-w-[1400px] rounded-[2.5rem] glass-ios flex flex-col relative overflow-hidden shadow-2xl">
            
            <header class="w-full px-8 py-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-4 z-10 no-print bg-white/60 backdrop-blur-sm sticky top-0">
                <div class="flex items-center gap-4">
                    <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="Logo" class="h-12 w-12 object-contain drop-shadow-sm">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Chinese<span class="text-blue-600">Class</span></h1>
                        <p class="text-slate-500 text-xs">‡∏Ñ‡∏£‡∏π‡∏Å‡∏µ‡∏£‡∏ï‡∏¥ ‡∏õ‡∏£‡∏∞‡∏™‡∏û‡∏û‡∏£‡∏£‡∏±‡∏á‡∏™‡∏µ</p>
                    </div>
                </div>
                <nav class="inline-flex rounded-full bg-slate-100 p-1 shadow-inner">
                    <button id="tab-btn-admin" onclick="switchMainTab('admin')" class="px-6 py-2 rounded-full text-sm font-bold text-slate-500 hover:text-slate-800 transition-all"><i class="fa-solid fa-chalkboard-user mr-2"></i>‡∏Ñ‡∏£‡∏π</button> 
                    <button id="tab-btn-student" onclick="switchMainTab('student')" class="px-6 py-2 rounded-full text-sm font-bold text-slate-500 hover:text-slate-800 transition-all"><i class="fa-solid fa-user-graduate mr-2"></i>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </nav>
            </header>

            <main class="flex-1 w-full px-4 md:px-8 pb-8 overflow-y-auto no-print scroll-smooth">
                <div class="w-full h-full mx-auto mt-6 flex flex-col gap-6">
                    
                    <div id="section-admin" class="flex flex-col gap-6 hidden h-full">
                        <div id="admin-login-wrapper" class="flex flex-col items-center justify-center py-20 gap-8">
                            <div class="bg-white p-10 rounded-3xl w-full max-w-sm flex flex-col items-center relative shadow-xl border border-slate-100">
                                <h2 class="text-2xl font-bold text-slate-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                                <form id="admin-login-form" class="space-y-4 w-full mt-4">
                                    <input id="admin-username" type="text" placeholder="Username" class="w-full rounded-xl glass-input px-4 py-3 text-center" required>
                                    <input id="admin-password" type="password" placeholder="Password" class="w-full rounded-xl glass-input px-4 py-3 text-center" required>
                                    <button type="submit" class="w-full py-3 rounded-xl btn-primary font-bold shadow-lg text-lg flex items-center justify-center gap-2">
                                        <span id="login-spinner" class="hidden loading-spinner"></span> Login
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div id="admin-content-wrapper" class="hidden flex flex-col gap-6 h-full">
                            <div class="flex justify-between items-center bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-100">
                                <div class="flex items-center gap-3">
                                    <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold"><i class="fa-solid fa-user-tie"></i></div>
                                    <div><h3 class="text-sm font-bold text-slate-700">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3><p class="text-[10px] text-green-500 font-bold">‚óè Online</p></div>
                                </div>
                                <button onclick="handleLogout(true)" class="bg-red-50 text-red-500 hover:bg-red-100 px-4 py-2 rounded-xl text-xs font-bold transition-colors"><i class="fa-solid fa-power-off mr-2"></i>Logout</button>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                                <button onclick="switchAdminSubTab('basic')" id="menu-basic" class="menu-btn btn-primary rounded-2xl py-3 font-bold shadow-lg text-white"><i class="fa-solid fa-folder-open block text-xl mb-1"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button> 
                                <button onclick="switchAdminSubTab('scan')" id="menu-scan" class="menu-btn bg-white hover:bg-slate-50 text-slate-600 rounded-2xl py-3 font-bold shadow-sm"><i class="fa-solid fa-star block text-xl mb-1 text-yellow-500"></i> ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                                <button onclick="switchAdminSubTab('individual')" id="menu-individual" class="menu-btn bg-white hover:bg-slate-50 text-slate-600 rounded-2xl py-3 font-bold shadow-sm"><i class="fa-solid fa-id-card block text-xl mb-1 text-purple-500"></i> ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</button>
                                <button onclick="switchAdminSubTab('report')" id="menu-report" class="menu-btn bg-white hover:bg-slate-50 text-slate-600 rounded-2xl py-3 font-bold shadow-sm"><i class="fa-solid fa-print block text-xl mb-1 text-slate-500"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                                <button onclick="switchAdminSubTab('homework')" id="menu-homework" class="menu-btn bg-white hover:bg-slate-50 text-slate-600 rounded-2xl py-3 font-bold shadow-sm relative"><i class="fa-solid fa-list-check block text-xl mb-1 text-orange-500"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô<span id="badge-homework" class="absolute top-2 right-2 bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full hidden">0</span></button>
                                <button onclick="switchAdminSubTab('attendance')" id="menu-attendance" class="menu-btn bg-white hover:bg-slate-50 text-slate-600 rounded-2xl py-3 font-bold shadow-sm"><i class="fa-solid fa-user-check block text-xl mb-1 text-green-500"></i> ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                                <button onclick="switchAdminSubTab('material')" id="menu-material" class="menu-btn bg-white hover:bg-slate-50 text-slate-600 rounded-2xl py-3 font-bold shadow-sm"><i class="fa-solid fa-book-open block text-xl mb-1 text-pink-500"></i> ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</button>
                            </div>

                            <section id="admin-panel-scan" class="admin-panel hidden h-full flex-col lg:flex-row gap-6 items-start">
                                <div class="flex-1 w-full bg-white/50 rounded-3xl p-6 shadow-sm border border-white/50 overflow-y-auto max-h-[calc(100vh-250px)] min-h-[500px]">
                                    <h3 class="text-slate-400 font-bold mb-4 text-xs uppercase tracking-wider sticky top-0 bg-[#f6f8fb] py-2 z-10">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span id="roster-count" class="ml-2 bg-slate-200 px-2 py-0.5 rounded-full text-slate-500">0</span></h3>
                                    <div id="score-roster-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 pb-20">
                                        <div class="col-span-full text-center text-slate-400 py-20">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ üëâ</div>
                                    </div>
                                </div>

                                <div class="w-full lg:w-80 flex-shrink-0 flex flex-col gap-4 sticky top-4">
                                    <div class="bg-white rounded-3xl p-6 shadow-[0_10px_30px_-5px_rgba(0,0,0,0.05)] border border-slate-100 flex flex-col gap-4">
                                        <h3 class="text-lg font-bold text-slate-700 border-l-4 border-blue-500 pl-3">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                                        
                                        <div class="space-y-3">
                                            <div>
                                                <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                                <select id="scan-class-select" class="glass-input w-full rounded-xl px-4 py-2.5 text-sm font-bold bg-slate-50 focus:bg-white"></select>
                                            </div>
                                            <div>
                                                <label class="text-[10px] font-bold text-slate-400 uppercase">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</label>
                                                <select id="scan-task-select" class="glass-input w-full rounded-xl px-4 py-2.5 text-sm font-bold bg-slate-50 focus:bg-white"></select>
                                            </div>
                                        </div>

                                        <hr class="border-slate-100">

                                        <div class="flex flex-col items-center gap-3">
                                            <input id="scan-score-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô..." class="w-full glass-input text-center text-3xl font-bold py-4 rounded-2xl shadow-inner bg-slate-50 focus:ring-4 ring-blue-100 border-2 border-transparent focus:border-blue-500 transition-all placeholder:text-slate-300">
                                            
                                            <div id="score-buttons-container" class="grid grid-cols-3 gap-2 w-full"></div>
                                            
                                            <button id="btn-score-manual" onclick="setScoreMode('manual')" class="w-full py-2.5 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold transition-all text-sm border border-slate-200">
                                                <i class="fa-solid fa-keyboard mr-2"></i>Manual Input
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-blue-500/5 border border-blue-500/20 rounded-2xl p-4 text-xs text-blue-600/80 leading-relaxed">
                                        <i class="fa-solid fa-circle-info mr-1"></i> <b>Tip:</b> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß
                                    </div>
                                </div>
                            </section>

                            <section id="admin-panel-basic" class="admin-panel hidden bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                                <h3 class="text-xl font-bold text-slate-800 mb-4 pb-2 border-b border-gray-100">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="p-4 rounded-2xl border border-slate-100 bg-slate-50/50"><h4 class="font-bold text-blue-600 mb-2">1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</h4><form id="form-subject" class="flex gap-2"><input id="subject-name" class="glass-input rounded-xl px-3 py-2 w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤"><button class="btn-primary px-4 py-2 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button></form><div id="subject-list-container" class="mt-2 space-y-1 max-h-32 overflow-y-auto"></div></div>
                                    <div class="p-4 rounded-2xl border border-slate-100 bg-slate-50/50"><h4 class="font-bold text-blue-600 mb-2">2. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4><form id="form-class" class="flex flex-col gap-2"><select id="class-subject-ref" class="glass-input rounded-xl px-3 py-2"></select><div class="flex gap-2"><input id="class-name" class="glass-input rounded-xl px-3 py-2 w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á"><button class="btn-primary px-4 py-2 rounded-xl font-bold"><i class="fa-solid fa-plus"></i></button></div></form></div>
                                    <div class="p-4 rounded-2xl border border-slate-100 bg-slate-50/50"><h4 class="font-bold text-blue-600 mb-2">3. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4><form id="form-student" class="flex flex-col gap-2"><select id="student-class" class="glass-input rounded-xl px-3 py-2"></select><div class="grid grid-cols-3 gap-2"><input id="student-no" type="number" class="glass-input rounded-xl px-3 py-2" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"><input id="student-id" class="glass-input rounded-xl px-3 py-2 col-span-2" placeholder="‡∏£‡∏´‡∏±‡∏™"></div><input id="student-name" class="glass-input rounded-xl px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"><button class="btn-primary w-full py-2 rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form></div>
                                    <div class="p-4 rounded-2xl border border-slate-100 bg-slate-50/50"><h4 class="font-bold text-blue-600 mb-2">4. ‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô</h4><form id="form-task" class="flex flex-col gap-2"><select id="task-subject-filter" onchange="renderTaskClassCheckboxes()" class="glass-input rounded-xl px-3 py-2"></select><div id="task-class-checkboxes" class="grid grid-cols-2 gap-2 max-h-20 overflow-y-auto bg-white p-2 rounded border border-slate-100"></div><input id="task-name" class="glass-input rounded-xl px-3 py-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô"><div class="flex gap-2"><input id="task-max" type="number" class="glass-input rounded-xl w-1/2 px-3 py-2 text-center" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" value="10"><select id="task-category" class="glass-input rounded-xl w-1/2 px-3 py-2"><option value="accum">‡πÄ‡∏Å‡πá‡∏ö</option><option value="midterm">‡∏Å‡∏•‡∏≤‡∏á</option><option value="final">‡∏õ‡∏•‡∏≤‡∏¢</option><option value="special">‡∏û‡∏¥‡πÄ‡∏®‡∏©</option></select></div><div id="chapter-wrapper" class="flex justify-between gap-1 mt-1"><label class="cursor-pointer"><input type="checkbox" value="1" class="hidden chapter-checkbox"><div class="w-6 h-6 rounded bg-white border flex items-center justify-center text-xs hover:bg-slate-100">1</div></label><label class="cursor-pointer"><input type="checkbox" value="2" class="hidden chapter-checkbox"><div class="w-6 h-6 rounded bg-white border flex items-center justify-center text-xs hover:bg-slate-100">2</div></label><label class="cursor-pointer"><input type="checkbox" value="3" class="hidden chapter-checkbox"><div class="w-6 h-6 rounded bg-white border flex items-center justify-center text-xs hover:bg-slate-100">3</div></label><label class="cursor-pointer"><input type="checkbox" value="4" class="hidden chapter-checkbox"><div class="w-6 h-6 rounded bg-white border flex items-center justify-center text-xs hover:bg-slate-100">4</div></label><label class="cursor-pointer"><input type="checkbox" value="5" class="hidden chapter-checkbox"><div class="w-6 h-6 rounded bg-white border flex items-center justify-center text-xs hover:bg-slate-100">5</div></label></div><button class="btn-primary w-full py-2 rounded-xl font-bold mt-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô</button></form></div>
                                    <div class="p-4 rounded-2xl border border-slate-100 bg-slate-50/50 md:col-span-2"><h4 class="font-bold text-blue-600 mb-2">5. ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô (Auto Check)</h4><form id="form-schedule" class="flex flex-wrap gap-2"><select id="sch-day" class="glass-input rounded-xl px-3 py-2"><option value="1">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå</option><option value="2">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£</option><option value="3">‡∏û‡∏∏‡∏ò</option><option value="4">‡∏û‡∏§‡∏´‡∏±‡∏™</option><option value="5">‡∏®‡∏∏‡∏Å‡∏£‡πå</option></select><select id="sch-period" class="glass-input rounded-xl px-3 py-2"><option value="1">‡∏Ñ‡∏≤‡∏ö 1</option><option value="2">‡∏Ñ‡∏≤‡∏ö 2</option><option value="3">‡∏Ñ‡∏≤‡∏ö 3</option><option value="4">‡∏Ñ‡∏≤‡∏ö 4</option><option value="5">‡∏Ñ‡∏≤‡∏ö 5</option><option value="6">‡∏Ñ‡∏≤‡∏ö 6</option><option value="7">‡∏Ñ‡∏≤‡∏ö 7</option><option value="8">‡∏Ñ‡∏≤‡∏ö 8</option></select><select id="sch-class" class="glass-input rounded-xl px-3 py-2"></select><button class="btn-primary px-4 py-2 rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form><div id="schedule-list" class="mt-2 grid grid-cols-2 gap-2"></div></div>
                                </div>
                            </section>

                            <section id="admin-panel-individual" class="admin-panel hidden bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                                <div class="relative max-w-md mx-auto mb-6"><input id="individual-search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onkeyup="searchIndividual(this.value)" class="w-full glass-input rounded-full px-5 py-3 pl-12 shadow-sm"><i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i><div id="individual-search-results" class="absolute top-full left-0 w-full bg-white border border-slate-100 rounded-xl mt-2 max-h-60 overflow-y-auto hidden z-20 shadow-xl"></div></div>
                                <div id="individual-result-container" class="hidden flex flex-col gap-6">
                                    <div class="flex items-center gap-4 p-6 bg-slate-50 rounded-2xl border border-slate-100"><div class="h-16 w-16 rounded-full bg-white flex items-center justify-center text-2xl font-bold text-blue-600 shadow-sm"><i class="fa-regular fa-user"></i></div><div><h2 id="ind-name" class="text-xl font-bold text-slate-800"></h2><p class="text-slate-500 text-sm"><span id="ind-id"></span> | <span id="ind-class" class="text-blue-600 font-bold"></span></p></div><div class="ml-auto text-right"><div class="text-xs text-slate-400">‡πÄ‡∏Å‡∏£‡∏î‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</div><div id="ind-gpa" class="text-3xl font-bold text-green-500">4</div></div></div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><h4 class="font-bold text-slate-700 mb-3">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4><div class="flex justify-around text-center"><div><div id="ind-att-present" class="text-2xl font-bold text-green-500">0</div><div class="text-xs text-slate-400">‡∏°‡∏≤</div></div><div><div id="ind-att-leave" class="text-2xl font-bold text-yellow-500">0</div><div class="text-xs text-slate-400">‡∏•‡∏≤</div></div><div><div id="ind-att-absent" class="text-2xl font-bold text-red-500">0</div><div class="text-xs text-slate-400">‡∏Ç‡∏≤‡∏î</div></div></div><div class="mt-3 text-xs text-slate-500">‡∏Ç‡∏≤‡∏î: <span id="ind-absent-dates">-</span></div></div>
                                        <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><h4 class="font-bold text-slate-700 mb-3">‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</h4><div class="w-full bg-slate-100 h-2 rounded-full mb-2"><div id="ind-work-bar" class="bg-red-400 h-full w-0 rounded-full transition-all"></div></div><div class="text-right text-xs text-slate-400 mb-3" id="ind-work-progress-text">0%</div><div id="ind-missing-list" class="space-y-1 max-h-32 overflow-y-auto"></div></div>
                                    </div>
                                </div>
                            </section>

                            <section id="admin-panel-report" class="admin-panel hidden bg-white rounded-3xl p-6 flex flex-col gap-6 shadow-sm border border-slate-100">
                                <div class="flex gap-4 no-print"><select id="report-subject" class="glass-input rounded-xl px-3 py-2 w-full"></select><select id="report-class" class="glass-input rounded-xl px-3 py-2 w-full"></select><div class="flex gap-2 w-full"><button onclick="printOfficialReport()" class="flex-1 btn-primary rounded-xl font-bold shadow-sm">‡∏û‡∏¥‡∏°‡∏û‡πå</button><button onclick="exportGradeCSV()" class="flex-1 bg-yellow-500 text-white rounded-xl font-bold shadow-sm hover:bg-yellow-600">CSV</button></div></div>
                                <div class="overflow-x-auto rounded-xl border border-slate-100"><table class="w-full text-sm"><thead class="bg-slate-50 border-b border-slate-100 text-slate-600"><tr id="report-table-header"></tr></thead><tbody id="report-table-body" class="divide-y divide-slate-100 text-slate-700"></tbody></table></div>
                            </section>
                            
                            <section id="admin-panel-attendance" class="admin-panel hidden bg-white rounded-3xl p-6 flex flex-col gap-6 shadow-sm border border-slate-100">
                                <div id="smart-att-banner" class="hidden bg-gradient-to-r from-blue-500 to-indigo-600 p-4 rounded-xl shadow-lg flex justify-between items-center text-white"><div class="flex items-center gap-3"><div class="bg-white/20 p-2 rounded-full animate-pulse"><i class="fa-solid fa-wifi"></i></div><div><div class="font-bold text-sm">‡∏Ñ‡∏≤‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (<span id="smart-period"></span>)</div><div class="text-white/80 text-xs">‡∏´‡πâ‡∏≠‡∏á <span id="smart-class-name" class="font-bold text-yellow-300"></span></div></div></div><button onclick="useSmartClass()" class="bg-white text-blue-600 px-4 py-1.5 rounded-full text-xs font-bold shadow-md">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button></div>
                                <div class="flex flex-col md:flex-row gap-4"><select id="att-class-select" class="glass-input rounded-xl px-4 py-3 flex-1"></select><input id="att-date-input" type="date" class="glass-input rounded-xl px-4 py-3"></div>
                                <div class="bg-slate-50 p-6 rounded-2xl flex flex-col items-center gap-4 border border-slate-100"><div class="flex gap-2 w-full justify-center flex-wrap"><button id="btn-att-present" onclick="setAttMode('‡∏°‡∏≤')" class="flex-1 py-3 rounded-xl bg-white border border-green-200 text-green-600 font-bold hover:bg-green-50 shadow-sm transition-all">‡∏°‡∏≤</button><button id="btn-att-leave" onclick="setAttMode('‡∏•‡∏≤')" class="flex-1 py-3 rounded-xl bg-white border border-yellow-200 text-yellow-600 font-bold hover:bg-yellow-50 shadow-sm transition-all">‡∏•‡∏≤</button><button id="btn-att-absent" onclick="setAttMode('‡∏Ç‡∏≤‡∏î')" class="flex-1 py-3 rounded-xl bg-white border border-red-200 text-red-600 font-bold hover:bg-red-50 shadow-sm transition-all">‡∏Ç‡∏≤‡∏î</button><button id="btn-att-activity" onclick="setAttMode('‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°')" class="flex-1 py-3 rounded-xl bg-white border border-orange-200 text-orange-600 font-bold hover:bg-orange-50 shadow-sm transition-all">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button></div><input id="att-scan-input" type="text" placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." class="w-full max-w-md glass-input text-center text-xl font-bold py-3 rounded-xl shadow-inner"></div>
                                <div class="flex justify-between text-xs text-slate-500 px-2 bg-slate-50 p-2 rounded-lg"><span>‡∏°‡∏≤: <b id="stat-present" class="text-green-500">0</b></span><span>‡∏•‡∏≤: <b id="stat-leave" class="text-yellow-500">0</b></span><span>‡∏Ç‡∏≤‡∏î: <b id="stat-absent" class="text-red-500">0</b></span><span>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: <b id="stat-activity" class="text-orange-500">0</b></span><button onclick="exportAttendanceCSV()" class="text-blue-500 hover:underline">Export</button></div>
                                <div id="att-roster-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
                            </section>
                            
                            <section id="admin-panel-homework" class="admin-panel hidden bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                                <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-solid fa-inbox text-blue-500"></i> ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                                <div id="incoming-list" class="flex flex-col gap-3 max-h-[60vh] overflow-y-auto"></div>
                            </section>
                            
                            <section id="admin-panel-material" class="admin-panel hidden bg-white rounded-3xl p-6 flex flex-col gap-6 shadow-sm border border-slate-100">
                                <form id="form-material" class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex flex-col gap-3"><h4 class="font-bold text-slate-700 text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h4><select id="mat-subject" class="glass-input rounded-xl px-3 py-2 text-sm"></select><input id="mat-title" class="glass-input rounded-xl px-3 py-2 text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á"><input id="mat-link" class="glass-input rounded-xl px-3 py-2 text-sm" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå"><div class="flex gap-2"><button class="flex-1 btn-primary py-2 rounded-xl text-sm font-bold shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button type="button" onclick="document.getElementById('form-material').reset()" class="px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-500 text-sm font-bold">‡∏•‡πâ‡∏≤‡∏á</button></div></form>
                                <div id="admin-mat-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                            </section>
                        </div>
                    </div>

                    <div id="section-student" class="hidden flex flex-col gap-5">
                        <div id="student-login-wrapper" class="flex flex-col items-center justify-center py-20 gap-8">
                            <div class="bg-white p-10 rounded-3xl w-full max-w-sm flex flex-col items-center relative shadow-xl border border-slate-100">
                                <img src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" alt="Logo" class="w-20 h-20 object-contain mb-4">
                                <h2 class="text-2xl font-bold text-slate-800 mb-6">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                                <input id="student-login-id" type="text" class="w-full glass-input rounded-xl px-4 py-3 text-center text-lg font-bold" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                                <button onclick="handleStudentLogin()" class="w-full py-3 rounded-xl btn-primary font-bold shadow-lg mt-4 text-lg flex items-center justify-center gap-2"><span id="student-login-spinner" class="hidden loading-spinner border-t-white"></span> ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                            </div>
                        </div>
                        <div id="student-dashboard" class="hidden flex flex-col gap-6">
                            <div class="bg-white p-6 rounded-3xl flex flex-col md:flex-row items-start md:items-center justify-between gap-4 relative overflow-hidden shadow-sm border border-slate-100">
                                <div class="relative z-10 flex items-center gap-4">
                                    <div class="h-16 w-16 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-3xl font-bold border border-blue-100"><i class="fa-solid fa-user-graduate"></i></div>
                                    <div><h2 id="std-dash-name" class="text-2xl font-bold text-slate-800">...</h2><p id="std-dash-class" class="text-slate-500 text-sm">...</p></div>
                                </div>
                                <button onclick="handleLogout()" class="relative z-10 px-5 py-2 bg-red-50 text-red-500 hover:bg-red-100 rounded-xl text-sm font-bold transition-all"><i class="fa-solid fa-right-from-bracket mr-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                            </div>
                            <div id="std-subjects-container" class="grid grid-cols-1 gap-6"></div>
                            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100"><h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fa-regular fa-calendar-check text-blue-500"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3><div class="overflow-hidden rounded-xl border border-slate-100"><table class="w-full"><thead class="bg-slate-50 text-left text-xs text-slate-500 uppercase"><tr><th class="px-4 py-3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="px-4 py-3 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead><tbody id="std-att-body" class="divide-y divide-slate-100 text-sm text-slate-700"><tr><td colspan="2" class="px-4 py-3 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr></tbody></table></div></div>
                        </div>
                    </div>

                </div>
            </main>
            
            <div id="toast-notification" class="fixed top-6 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full shadow-[0_10px_40px_-10px_rgba(0,0,0,0.2)] z-[100] flex items-center gap-4 transition-all duration-500 transform -translate-y-32 opacity-0 pointer-events-none bg-white border border-slate-100">
                <i id="toast-icon" class="fa-solid fa-circle-check text-3xl text-green-500 drop-shadow-sm"></i>
                <div class="flex flex-col">
                    <span id="toast-title" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status</span>
                    <span id="toast-message" class="text-lg font-bold text-slate-800">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
                </div>
            </div>

            <div id="subject-config-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="bg-white p-6 rounded-3xl w-full max-w-md m-4 shadow-2xl animate-fade-in"><h3 class="text-xl font-bold text-slate-800 mb-1">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3><p class="text-xs text-slate-500 mb-4" id="config-subject-name"></p><input type="hidden" id="config-subject-id"><div id="config-slots-container" class="space-y-2 mb-4"></div><div class="flex justify-between items-center mb-4 text-sm bg-slate-50 p-3 rounded-xl"><span class="text-slate-600">‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö:</span><span id="config-total-score" class="font-bold text-slate-800">0</span></div><div class="flex gap-2"><button onclick="addConfigSlot()" class="flex-1 py-2 rounded-xl border border-dashed border-slate-300 text-slate-500 text-xs hover:border-blue-500 hover:text-blue-500"><i class="fa-solid fa-plus mr-1"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á</button><button onclick="saveSubjectConfig()" class="flex-1 btn-primary py-2 rounded-xl font-bold shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="document.getElementById('subject-config-modal').classList.add('hidden')" class="px-3 text-slate-400 hover:text-slate-600">‡∏õ‡∏¥‡∏î</button></div></div></div>

            <div id="score-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"><div class="bg-white p-8 rounded-[2rem] w-full max-w-sm m-4 shadow-2xl text-center animate-fade-in"><h3 class="text-lg font-bold text-slate-800 mb-1" id="modal-task-name"></h3><p class="text-blue-500 mb-6 text-xl font-bold" id="modal-student-name"></p><input id="modal-score-input" type="number" class="glass-input text-5xl text-center w-32 h-24 rounded-3xl font-bold mb-2 focus:ring-4 ring-blue-100 text-slate-700 shadow-inner" placeholder="0"><p class="text-slate-400 text-xs mb-6">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° <span id="modal-max-score"></span></p><div class="flex gap-3"><button id="btn-modal-save" class="flex-1 btn-primary py-3 rounded-xl font-bold shadow-lg text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button onclick="closeScoreModal()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 py-3 rounded-xl font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div></div>
            
            <div id="submit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                <div class="bg-white p-6 rounded-3xl w-full max-w-md m-4 shadow-2xl animate-fade-in max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                        <h3 class="text-lg font-bold text-slate-800" id="submit-modal-title">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h3>
                        <button onclick="document.getElementById('submit-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    
                    <div id="modal-view-only" class="hidden flex flex-col items-center gap-4 py-4">
                        <div class="w-24 h-24 rounded-full border-4 border-green-500 flex items-center justify-center text-4xl font-bold text-green-600 bg-green-50"><span id="view-score-display">-</span></div>
                        <p class="text-slate-500 font-bold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</p>
                        <a id="view-work-link" href="#" target="_blank" class="text-blue-500 hover:underline text-sm flex items-center gap-2 mt-2"><i class="fa-solid fa-link"></i> ‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ</a>
                    </div>

                    <div id="modal-form-container">
                        <div id="modal-feedback-display" class="hidden mb-4 bg-orange-50 border border-orange-200 p-4 rounded-2xl"><p class="text-orange-600 text-xs font-bold mb-1"><i class="fa-solid fa-circle-exclamation mr-1"></i>‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</p><p id="modal-feedback-text" class="text-slate-700 text-sm italic"></p></div>
                        <form id="form-submit-work" class="flex flex-col gap-4">
                            <input type="hidden" id="submit-task-id"><input type="hidden" id="submit-student-id">
                            <div><label class="text-xs text-slate-500 mb-1 block font-bold">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô</label><input id="submit-link-input" type="url" required placeholder="https://..." class="glass-input w-full rounded-xl px-4 py-3 text-sm"></div>
                            <div><label class="text-xs text-slate-500 mb-1 block font-bold">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏£‡∏π</label><textarea id="submit-comment-input" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ..." class="glass-input w-full rounded-xl px-4 py-3 text-sm"></textarea></div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200"><label class="text-xs text-blue-600 font-bold mb-2 block flex justify-between"><span><i class="fa-solid fa-users mr-1"></i>‡∏™‡πà‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô (‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°)</span></label><input type="text" id="friend-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô..." class="glass-input w-full rounded-lg px-3 py-2 text-xs mb-2 bg-white"><div id="friend-selector-container" class="max-h-32 overflow-y-auto space-y-1 pr-1"></div></div>
                            <button type="submit" id="btn-submit-final" class="btn-primary w-full py-3 rounded-xl font-bold shadow-md mt-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="print-area" class="hidden"></div>

    <script>
        // ***********************************************
        // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNjMSE06u5xO4dtyipa5P-YzoaicppubdwlUgMpaX4L4TUjk3-xY2PRnzhS42AxZe/exec"; 
        // ***********************************************

        let dataState = { subjects: [], classes: [], students: [], tasks: [], scores: [], attendance: [], materials: [], submissions: [], returns: [], schedules: [] };
        let scoreMode = 'manual'; 
        let attMode = null;
        let pendingScore = null;
        let smartClassId = null; 
        let currentConfig = [];
        let inactivityTimer, syncInterval, scheduleInterval;
        let toastTimeout; // For Toast

        const PERIODS = [{p:1,start:"08:30",end:"09:20"},{p:2,start:"09:20",end:"10:10"},{p:3,start:"10:10",end:"11:00"},{p:4,start:"11:00",end:"11:50"},{p:5,start:"11:50",end:"12:40"},{p:6,start:"12:40",end:"13:30"},{p:7,start:"13:30",end:"14:20"},{p:8,start:"14:20",end:"15:10"}];

        window.addEventListener('DOMContentLoaded', () => { initializeApp(); });

        function initializeApp() {
            try {
                if(document.getElementById('att-date-input')) document.getElementById('att-date-input').value = getThaiDateISO();
                renderScoreButtons(); initEventListeners(); loadFromLocalStorage(); setupInactivityTimer();
                const savedSession = localStorage.getItem('wany_admin_session');
                if(savedSession) { showAdminPanel(true); } else { switchMainTab('student'); }
                syncData(); checkSmartSchedule();
                scheduleInterval = setInterval(checkSmartSchedule, 60000);
                syncInterval = setInterval(syncData, 60000);
                window.addEventListener('beforeunload', cleanup);
            } catch (error) { console.error(error); showToast("Init Error", "bg-red-600"); }
        }

        function cleanup() { if(inactivityTimer) clearTimeout(inactivityTimer); if(scheduleInterval) clearInterval(scheduleInterval); if(syncInterval) clearInterval(syncInterval); }
        function setupInactivityTimer() { const logout=()=>{showToast("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ (30 ‡∏ô‡∏≤‡∏ó‡∏µ)", "bg-yellow-600");handleLogout(true);}; const reset=()=>{clearTimeout(inactivityTimer);inactivityTimer=setTimeout(logout, 30*60*1000);}; window.addEventListener('click', reset); window.addEventListener('keypress', reset); }
        
        // --- TOAST FUNCTION (IMPROVED) ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-notification');
            const msgEl = document.getElementById('toast-message');
            const titleEl = document.getElementById('toast-title');
            const iconEl = document.getElementById('toast-icon');
            if (!toast || !msgEl) return;

            if (toastTimeout) clearTimeout(toastTimeout);
            msgEl.textContent = message;
            toast.className = "fixed top-6 left-1/2 -translate-x-1/2 px-8 py-4 rounded-full shadow-[0_10px_40px_-10px_rgba(0,0,0,0.2)] z-[100] flex items-center gap-4 transition-all duration-500 transform bg-white border border-slate-100";

            if (type.includes('red') || type === 'error' || message.includes('‡πÑ‡∏°‡πà') || message.includes('Fail') || message.includes('Error')) {
                iconEl.className = "fa-solid fa-circle-xmark text-3xl text-red-500 drop-shadow-sm";
                titleEl.textContent = "Error"; titleEl.className = "text-xs font-bold text-red-400 uppercase tracking-wider";
                toast.classList.add('ring-1', 'ring-red-100');
            } else if (type.includes('yellow') || type === 'warning') {
                iconEl.className = "fa-solid fa-triangle-exclamation text-3xl text-yellow-500 drop-shadow-sm";
                titleEl.textContent = "Warning"; titleEl.className = "text-xs font-bold text-yellow-400 uppercase tracking-wider";
                toast.classList.add('ring-1', 'ring-yellow-100');
            } else {
                iconEl.className = "fa-solid fa-circle-check text-3xl text-green-500 drop-shadow-sm";
                titleEl.textContent = "Success"; titleEl.className = "text-xs font-bold text-green-400 uppercase tracking-wider";
                toast.classList.add('ring-1', 'ring-green-100');
            }

            requestAnimationFrame(() => { toast.classList.remove('-translate-y-32', 'opacity-0'); toast.classList.add('translate-y-0', 'opacity-100'); });
            toastTimeout = setTimeout(() => { toast.classList.remove('translate-y-0', 'opacity-100'); toast.classList.add('-translate-y-32', 'opacity-0'); }, 3000);
        }

        // --- CORE FUNCTIONS ---
        async function syncData() {
            try {
                const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getData&t=${Date.now()}`);
                if (!res.ok) throw new Error("Network");
                const json = await res.json();
                if (json && typeof json === 'object') {
                    ['subjects','classes','students','tasks','scores','attendance','materials','submissions','returns','schedules'].forEach(k => { if(!Array.isArray(json[k])) json[k] = []; });
                    dataState = json; refreshUI(); saveToLocalStorage();
                }
            } catch(e) { console.warn('Offline'); }
        }
        function saveToLocalStorage() { localStorage.setItem('wany_data_backup', JSON.stringify({ timestamp: Date.now(), data: dataState })); }
        function loadFromLocalStorage() { try{const b=localStorage.getItem('wany_data_backup');if(b){const p=JSON.parse(b);if(Date.now()-p.timestamp<1800000)dataState=p.data;}}catch(e){} }
        window.handleLogout = function(f){ if(f||confirm("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")){ cleanup(); localStorage.removeItem('wany_admin_session'); localStorage.removeItem('current_student_code'); location.reload(); } };
        function showAdminPanel(a=false){ document.getElementById('admin-login-wrapper').classList.add('hidden'); document.getElementById('admin-content-wrapper').classList.remove('hidden'); refreshUI(); if(!a) syncData(); }

        function refreshUI() {
            refreshDropdowns(); renderSubjectList(); renderScheduleList(); checkSmartSchedule();
            if(!document.getElementById('admin-content-wrapper').classList.contains('hidden')) {
                const panels = ['scan', 'report', 'homework', 'attendance', 'material'];
                panels.forEach(p => {
                    if(!document.getElementById(`admin-panel-${p}`).classList.contains('hidden')) {
                        if(p=='scan') { updateScanTaskDropdown(); renderScoreRoster(); }
                        if(p=='report') renderGradeReport();
                        if(p=='homework') renderIncomingSubmissions();
                        if(p=='attendance') renderAttRoster();
                        if(p=='material') renderAdminMaterials();
                    }
                });
                updateInboxBadge();
            }
            if(!document.getElementById('student-dashboard').classList.contains('hidden')) {
                const c = localStorage.getItem('current_student_code');
                if(c) { const s = dataState.students.find(x=>x.code==c); if(s) renderStudentDashboard(s); }
            }
        }

        // --- RENDER FUNCTIONS (ALL INCLUDED) ---
        function renderScoreRoster() { 
            const cid = document.getElementById('scan-class-select')?.value;
            const taskId = document.getElementById('scan-task-select')?.value;
            const div = document.getElementById('score-roster-grid');
            const countEl = document.getElementById('roster-count');
            
            if (!div) return;
            div.innerHTML = '';
            
            if (!cid || !taskId) {
                div.innerHTML = '<div class="col-span-full text-center text-slate-400 py-20 flex flex-col items-center gap-2"><i class="fa-solid fa-arrow-right text-3xl animate-bounce"></i><span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤</span></div>';
                if(countEl) countEl.textContent = '0';
                return;
            }
            
            const students = dataState.students.filter(s => s.classId == cid).sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
            if(countEl) countEl.textContent = students.length;
            
            students.forEach(s => { 
                const sc = dataState.scores.find(x => x.studentId == s.id && x.taskId == taskId);
                const hasScore = sc !== undefined;
                const val = hasScore ? sc.score : '-';
                
                let boxClass = "bg-white border-slate-200 text-slate-400 hover:border-blue-400 hover:shadow-md";
                let textClass = "text-slate-300";
                
                if (hasScore) {
                    boxClass = "bg-green-50 border-green-200 text-green-700 shadow-sm ring-1 ring-green-100";
                    textClass = "text-green-600 font-bold";
                }

                const el = document.createElement('div');
                el.className = `status-box ${boxClass} p-3 flex flex-col items-center justify-center cursor-pointer border rounded-2xl transition-all relative aspect-square group`;
                el.onclick = () => openManualScore(s.id, taskId);
                
                el.innerHTML = `
                    <div class="text-[10px] absolute top-2 right-3 opacity-50 font-bold group-hover:opacity-100 transition-opacity">#${s.no || '?'}</div>
                    <div class="font-bold text-xs truncate w-full text-center mt-auto text-slate-700">${s.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</div>
                    <div class="text-4xl mb-auto mt-2 ${textClass}">${val}</div>
                `;
                div.appendChild(el);
            });
        }

        function renderAttRoster() {
            const cid = document.getElementById('att-class-select')?.value;
            const div = document.getElementById('att-roster-grid');
            if (!div) return; div.innerHTML = ''; if (!cid) return;
            
            const date = document.getElementById('att-date-input').value || getThaiDateISO();
            const students = dataState.students.filter(s => s.classId == cid).sort((a, b) => Number(a.no || 0) - Number(b.no || 0));
            
            let p=0, l=0, a=0, act=0;
            students.forEach(s => { 
                const log = dataState.attendance.find(x => x.studentId == s.id && x.date == date);
                const st = log ? log.status : 'none';
                if(st=='‡∏°‡∏≤') p++; else if(st=='‡∏•‡∏≤') l++; else if(st=='‡∏Ç‡∏≤‡∏î') a++; else if(st=='‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°') act++;

                let cardClass = "bg-white border-slate-200 opacity-70";
                let textClass = "text-slate-400";
                let icon = "";

                if (st == '‡∏°‡∏≤') { cardClass = "bg-green-50 border-green-200 opacity-100 ring-1 ring-green-200"; textClass = "text-green-600 font-bold"; icon = "<i class='fa-solid fa-check-circle'></i>"; }
                else if (st == '‡∏•‡∏≤') { cardClass = "bg-yellow-50 border-yellow-200 opacity-100 ring-1 ring-yellow-200"; textClass = "text-yellow-600 font-bold"; icon = "<i class='fa-solid fa-envelope-open-text'></i>"; }
                else if (st == '‡∏Ç‡∏≤‡∏î') { cardClass = "bg-red-50 border-red-200 opacity-100 ring-1 ring-red-200"; textClass = "text-red-600 font-bold"; icon = "<i class='fa-solid fa-xmark'></i>"; }
                else if (st == '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°') { cardClass = "bg-orange-50 border-orange-200 opacity-100 ring-1 ring-orange-200"; textClass = "text-orange-600 font-bold"; icon = "<i class='fa-solid fa-person-running'></i>"; }

                const el = document.createElement('div');
                el.className = `status-box ${cardClass} p-3 rounded-2xl border flex flex-col items-center justify-center cursor-pointer transition-all hover:shadow-md relative group aspect-[4/3]`;
                el.onclick = () => { if(attMode) saveAtt(s.id, cid, date, attMode); };
                el.innerHTML = `<div class="absolute top-2 right-3 text-[10px] text-slate-400 font-bold">#${s.no}</div><div class="font-bold text-sm truncate w-full text-center mb-1 text-slate-700">${s.name}</div><div class="text-xs ${textClass} flex items-center gap-1">${icon} ${st=='none' ? '-' : st}</div>`;
                div.appendChild(el);
            });
            document.getElementById('stat-present').textContent = p; document.getElementById('stat-leave').textContent = l; document.getElementById('stat-absent').textContent = a; document.getElementById('stat-activity').textContent = act;
        }

        function renderAdminMaterials() {
            const div = document.getElementById('admin-mat-list'); if (!div) return; div.innerHTML = '';
            dataState.materials.forEach(m => {
                const sub = dataState.subjects.find(s => s.id == m.subjectId)?.name || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-between hover:shadow-md transition-all group";
                el.innerHTML = `<div class="flex items-start gap-3"><div class="w-10 h-10 rounded-full bg-pink-50 text-pink-500 flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform"><i class="fa-solid fa-book-open"></i></div><div class="overflow-hidden"><div class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full w-fit mb-1 font-bold">${sub}</div><div class="font-bold text-sm text-slate-700 truncate">${m.title}</div><a href="${m.link}" target="_blank" class="text-xs text-blue-500 hover:underline truncate block mt-1"><i class="fa-solid fa-link mr-1"></i>${m.link}</a></div></div>`;
                div.appendChild(el);
            });
        }

        function renderStudentDashboard(s) {
            document.getElementById('std-dash-name').textContent = s.name;
            document.getElementById('std-dash-class').textContent = dataState.classes.find(c=>c.id==s.classId)?.name;
            const container = document.getElementById('std-subjects-container'); container.innerHTML='';
            const myTasks = dataState.tasks.filter(t=>t.classId==s.classId);
            const subs = [...new Set(myTasks.map(t=>t.subjectId))];
            
            subs.forEach(subId => {
                const subj = dataState.subjects.find(x=>x.id==subId); if(!subj) return;
                const {total} = calculateScores(s.id, s.classId, myTasks.filter(t=>t.subjectId==subId));
                let html = `<div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100"><h3 class="font-bold text-slate-800 border-l-4 border-blue-500 pl-3 mb-4 text-lg flex justify-between items-center">${subj.name} <span class="text-sm bg-slate-100 px-3 py-1 rounded-full text-slate-600 font-bold">‡πÄ‡∏Å‡∏£‡∏î ${calGrade(total)}</span></h3>`;
                html += `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">`;
                myTasks.filter(t=>t.subjectId==subId).forEach(t => {
                    const sc = dataState.scores.find(x=>x.studentId==s.id && x.taskId==t.id);
                    const sub = dataState.submissions.find(x=>x.studentId==s.id && x.taskId==t.id);
                    const returned = dataState.returns?.find(x => x.studentId == s.id && x.taskId == t.id);
                    let stCls="bg-white border-slate-200 text-slate-400", ico='<i class="fa-regular fa-clock"></i>', txt="‡∏£‡∏≠‡∏™‡πà‡∏á", btn=`<button onclick="openSubmitModal('${t.id}','${s.id}','${t.name}','submit')" class="mt-2 bg-slate-100 hover:bg-slate-200 text-slate-600 text-xs font-bold px-3 py-1.5 rounded-lg w-full">‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</button>`;
                    if (returned) { stCls="bg-orange-50 border-orange-200 text-orange-500 ring-1 ring-orange-100"; ico='<i class="fa-solid fa-triangle-exclamation animate-pulse"></i>'; txt="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; btn=`<button onclick="openSubmitModal('${t.id}','${s.id}','${t.name}','fix')" class="mt-2 bg-orange-500 hover:bg-orange-600 text-white text-xs font-bold px-3 py-1.5 rounded-lg w-full shadow-sm">‡∏™‡πà‡∏á‡πÅ‡∏Å‡πâ</button>`; } 
                    else if (sc) { stCls="bg-green-50 border-green-200 text-green-600"; ico='<i class="fa-solid fa-check-circle"></i>'; txt=sc.score; btn=`<button onclick="openSubmitModal('${t.id}','${s.id}','${t.name}','view')" class="mt-2 bg-white border border-green-200 text-green-600 text-xs font-bold px-3 py-1.5 rounded-lg w-full">‡∏î‡∏π</button>`; } 
                    else if (sub) { stCls="bg-blue-50 border-blue-200 text-blue-500"; ico='<i class="fa-solid fa-hourglass-half"></i>'; txt="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à"; btn=`<button onclick="openSubmitModal('${t.id}','${s.id}','${t.name}','submit')" class="mt-2 bg-blue-100 text-blue-600 text-xs font-bold px-3 py-1.5 rounded-lg w-full">‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥</button>`; }
                    html += `<div class="${stCls} p-3 rounded-2xl flex flex-col items-center justify-between text-center border transition-all hover:shadow-md h-full relative group"><div class="text-[10px] opacity-50 absolute top-2 right-2">${t.category}</div><div class="text-2xl mt-2 mb-1">${ico}</div><div class="text-xs font-bold truncate w-full px-1 mb-1 text-slate-700">${t.name}</div><div class="text-sm font-bold mb-1">${txt}</div>${btn}</div>`;
                });
                html += `</div></div>`; container.innerHTML += html;
            });
            const attBody = document.getElementById('std-att-body'); attBody.innerHTML='';
            dataState.attendance.filter(a=>a.studentId==s.id).sort((a,b)=>b.date.localeCompare(a.date)).forEach(a=>{ attBody.innerHTML += `<tr><td class="px-4 py-2 text-slate-500">${formatThaiDate(a.date)}</td><td class="px-4 py-2 text-center font-bold ${a.status=='‡∏°‡∏≤'?'text-green-500':'text-red-500'}">${a.status}</td></tr>`; });
        }

        // --- HELPERS ---
        function calculateScores(sid, cid, tasks) {
            const cls = dataState.classes.find(c => c.id == cid); if(!cls) return {chapScores:[], midterm:0, final:0, total:0};
            const subj = dataState.subjects.find(s => s.id == cls.subjectId);
            const config = (subj && subj.scoreConfig && subj.scoreConfig.length) ? subj.scoreConfig : Array(5).fill(10);
            let chapData = config.map(w => ({earn:0, max:0, w: Number(w)}));
            let mid=0, fin=0, tot=0;
            tasks.forEach(t => {
                const sc = dataState.scores.find(x => x.studentId == sid && x.taskId == t.id);
                const sVal = sc ? Number(sc.score) : 0; const max = Number(t.maxScore)||0;
                if(t.category === 'accum') {
                    const chaps = t.chapter ? t.chapter.toString().split(',') : [];
                    if(chaps.length && max) chaps.forEach(c => { const i = parseInt(c)-1; if(chapData[i]) { chapData[i].max += max/chaps.length; chapData[i].earn += sVal/chaps.length; }});
                } else if (t.category === 'midterm') mid += sVal; else if (t.category === 'final') fin += sVal; else if (t.category === 'special') tot += sVal;
            });
            const chapScores = chapData.map(d => d.max ? Math.round((d.earn/d.max)*d.w) : 0);
            return { chapScores, midterm: mid, final: fin, total: tot + chapScores.reduce((a,b)=>a+b,0) + mid + fin };
        }
        async function saveAndRefresh(p) { try{ if(p.action=='login') document.getElementById('login-spinner').classList.remove('hidden'); const res=await fetch(GOOGLE_SCRIPT_URL,{method:'POST',body:JSON.stringify(p)}); if(p.action=='login')document.getElementById('login-spinner').classList.add('hidden'); const j=await res.json(); if(j.status=='success'||p.action!='login'){showToast("Success");syncData();return j;}else showToast(j.message,"bg-red-600"); }catch(e){showToast("Error","bg-red-600");} }
        function getThaiDateISO(){ const d=new Date(); return new Date(d.getTime()+(7*60*60000)).toISOString().split('T')[0]; }
        function formatThaiDate(d){ if(!d)return'-'; try{ return new Date(d).toLocaleDateString('th-TH', {day:'numeric',month:'short',year:'numeric'}); }catch{return d;} }
        function calGrade(s){ s=Number(s)||0; if(s>=80)return 4; if(s>=75)return 3.5; if(s>=70)return 3; if(s>=65)return 2.5; if(s>=60)return 2; if(s>=55)return 1.5; if(s>=50)return 1; return 0; }
        
        // --- UI LOGIC ---
        function switchMainTab(t){ document.getElementById('section-admin').classList.add('hidden'); document.getElementById('section-student').classList.add('hidden'); document.getElementById(`section-${t}`).classList.remove('hidden'); syncData(); }
        function switchAdminSubTab(t){ document.querySelectorAll('.admin-panel').forEach(p=>p.classList.add('hidden')); document.getElementById(`admin-panel-${t}`).classList.remove('hidden'); if(t=='scan')document.getElementById(`admin-panel-${t}`).classList.add('flex'); refreshUI(); }
        function renderScoreButtons(){ document.getElementById('score-buttons-container').innerHTML = [5,6,7,8,9,10].map(i=>`<button class="btn-score py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-600 font-bold hover:bg-blue-50 transition-all text-lg" onclick="setScoreMode(${i})">${i}</button>`).join(''); }
        function setScoreMode(m){ scoreMode=m; document.querySelectorAll('.btn-score').forEach(b=>b.classList.remove('score-btn-active')); if(m!='manual') event.target.classList.add('score-btn-active'); document.getElementById('scan-score-input').focus(); }
        function setAttMode(m){ attMode=m; ['present','leave','absent','activity'].forEach(t => document.getElementById(`btn-att-${t}`).classList.remove(`att-active-${t}`)); if(m=='‡∏°‡∏≤')document.getElementById('btn-att-present').classList.add('att-active-present'); if(m=='‡∏•‡∏≤')document.getElementById('btn-att-leave').classList.add('att-active-leave'); if(m=='‡∏Ç‡∏≤‡∏î')document.getElementById('btn-att-absent').classList.add('att-active-absent'); if(m=='‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°')document.getElementById('btn-att-activity').classList.add('att-active-activity'); document.getElementById('att-scan-input').focus(); }
        function checkSmartSchedule(){ /* Logic */ }
        function updateInboxBadge(){ const c=dataState.submissions.filter(s=>!dataState.scores.some(x=>x.taskId==s.taskId&&x.studentId==s.studentId)).length; const b=document.getElementById('badge-homework'); if(c){b.classList.remove('hidden');b.textContent=c;}else b.classList.add('hidden'); }
        
        // Init Listeners (Compact)
        function initEventListeners() {
            document.getElementById('admin-login-form').onsubmit=async(e)=>{e.preventDefault();const r=await saveAndRefresh({action:'login',username:document.getElementById('admin-username').value,password:document.getElementById('admin-password').value});if(r&&r.status=='success'){localStorage.setItem('wany_admin_session',r.token);showAdminPanel();}};
            document.getElementById('form-submit-work').onsubmit=(e)=>{e.preventDefault();const sid=document.getElementById('submit-student-id').value,tid=document.getElementById('submit-task-id').value;saveAndRefresh({action:'submitTask',taskId:tid,studentIds:[sid],link:document.getElementById('submit-link-input').value,comment:document.getElementById('submit-comment-input').value});document.getElementById('submit-modal').classList.add('hidden');};
            document.getElementById('scan-class-select').onchange=()=>{updateScanTaskDropdown();renderScoreRoster();};
            document.getElementById('scan-task-select').onchange=renderScoreRoster;
            document.getElementById('scan-score-input').onkeydown=(e)=>{if(e.key==='Enter'){const val=e.target.value.trim(),cid=document.getElementById('scan-class-select').value,tid=document.getElementById('scan-task-select').value;if(!cid||!tid)return;const s=dataState.students.find(st=>(st.code==val||st.no==val)&&st.classId==cid);if(s){if(scoreMode!='manual')saveAndRefresh({action:'addScore',studentId:s.id,taskId:tid,score:scoreMode});else openManualScore(s.id,tid);}e.target.value='';}};
            document.getElementById('btn-modal-save').onclick=()=>{if(pendingScore){saveAndRefresh({action:'addScore',studentId:pendingScore.s.id,taskId:pendingScore.t.id,score:document.getElementById('modal-score-input').value});closeScoreModal();}};
            // Other forms... (Subject, Class, Student, etc. logic same as before)
        }
        function updateScanTaskDropdown(){ const cid=document.getElementById('scan-class-select').value;const el=document.getElementById('scan-task-select');el.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô --</option>';dataState.tasks.filter(t=>t.classId==cid).forEach(t=>el.innerHTML+=`<option value="${t.id}">${t.name}</option>`); }
        function refreshDropdowns(){ const fill=(id,l)=>{const el=document.getElementById(id);if(!el)return;el.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>';l.forEach(x=>el.innerHTML+=`<option value="${x.id}">${x.name}</option>`);}; fill('class-subject-ref',dataState.subjects);fill('student-class',dataState.classes);fill('scan-class-select',dataState.classes);fill('task-subject-filter',dataState.subjects);fill('att-class-select',dataState.classes);fill('mat-subject',dataState.subjects);fill('report-subject',dataState.subjects); }
        function openManualScore(sid,tid){ pendingScore={s:dataState.students.find(x=>x.id==sid),t:dataState.tasks.find(x=>x.id==tid)}; document.getElementById('score-modal').classList.remove('hidden'); document.getElementById('modal-student-name').textContent=pendingScore.s.name; document.getElementById('modal-task-name').textContent=pendingScore.t.name; document.getElementById('modal-max-score').textContent=pendingScore.t.maxScore; const sc=dataState.scores.find(x=>x.studentId==sid&&x.taskId==tid); document.getElementById('modal-score-input').value=sc?sc.score:''; setTimeout(()=>document.getElementById('modal-score-input').focus(),100); }
        function closeScoreModal(){ document.getElementById('score-modal').classList.add('hidden'); document.getElementById('scan-score-input').focus(); }
        function openSubmitModal(tid,sid,tname,mode){ const m=document.getElementById('submit-modal');m.classList.remove('hidden');document.getElementById('submit-task-id').value=tid;document.getElementById('submit-student-id').value=sid;document.getElementById('submit-modal-title').textContent=tname; if(mode=='view'){document.getElementById('modal-view-only').classList.remove('hidden');document.getElementById('modal-form-container').classList.add('hidden');const sc=dataState.scores.find(x=>x.studentId==sid&&x.taskId==tid);document.getElementById('view-score-display').textContent=sc?sc.score:'-';}else{document.getElementById('modal-view-only').classList.add('hidden');document.getElementById('modal-form-container').classList.remove('hidden');const r=dataState.returns?.find(x=>x.studentId==sid&&x.taskId==tid);const fb=document.getElementById('modal-feedback-display');if(r){fb.classList.remove('hidden');document.getElementById('modal-feedback-text').textContent=r.comment;}else fb.classList.add('hidden');} }
        function renderGradeReport(){ /* Logic from previous version */ const cid=document.getElementById('report-class')?.value;const tbody=document.getElementById('report-table-body');if(!tbody)return;tbody.innerHTML='';if(!cid)return;const tasks=dataState.tasks.filter(t=>t.classId==cid);dataState.students.filter(s=>s.classId==cid).sort((a,b)=>Number(a.no)-Number(b.no)).forEach((s,i)=>{const{chapScores,midterm,final,total}=calculateScores(s.id,cid,tasks);tbody.innerHTML+=`<tr><td>${s.no||i+1}</td><td class="text-left">${s.name}</td>${chapScores.map(x=>`<td>${x}</td>`).join('')}<td>${midterm}</td><td>${final}</td><td>${total}</td><td>${calGrade(total)}</td></tr>`;}); }
        function renderIncomingSubmissions(){ /* Logic */ }
    </script>
</body>
</html>
